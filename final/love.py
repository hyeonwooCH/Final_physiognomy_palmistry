# -*- coding: utf-8 -*-
"""love.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Puv1SWMKsF9LHA9aBp8cS0S9JhemvNVZ

# ÌôòÍ≤ΩÏÑ§Ï†ï
"""

# =========================================================
# [1Îã®Í≥Ñ] ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏÑ§Ïπò Î∞è Îü∞ÌÉÄÏûÑ Í∞ïÏ†ú Ïû¨ÏãúÏûë
# =========================================================
import os

print("1. ÌïÑÏàò ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏÑ§Ïπò Ï§ë...")
!pip uninstall mediapipe -y
!pip install mediapipe==0.10.14

print("2. ÌïúÍ∏Ä Ìè∞Ìä∏ ÏÑ§Ïπò Ï§ë...")
!sudo apt-get install -y fonts-nanum
!sudo fc-cache -fv
!rm ~/.cache/matplotlib -rf

print("‚úÖ ÏÑ§Ïπò ÏôÑÎ£å. Îü∞ÌÉÄÏûÑÏùÑ Í∞ïÏ†úÎ°ú Ïû¨ÏãúÏûëÌï©ÎãàÎã§...")
print("‚ö†Ô∏è Ïû†Ïãú ÌõÑ 'ÏÑ∏ÏÖòÏù¥ Îã§Ïö¥ÎêòÏóàÏäµÎãàÎã§' Í≤ΩÍ≥†Í∞Ä Îú®Î©¥ Ï†ïÏÉÅÏù¥Îãà Îã´Í≥† [2Îã®Í≥Ñ]Î•º Ïã§ÌñâÌïòÏÑ∏Ïöî.")

# 1. YOLO(ultralytics) Î∞è MediaPipe ÏÑ§Ïπò
!pip install ultralytics mediapipe

# 2. ÌïúÍ∏Ä Ìè∞Ìä∏ ÏÑ§Ïπò (ÏãúÍ∞ÅÌôîÏóê ÌïÑÏöî)
!sudo apt-get install -y fonts-nanum
!sudo fc-cache -fv
!rm ~/.cache/matplotlib -rf

print("‚úÖ Î™®Îì† ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏÑ§ÏπòÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.")

# 1. Í∏∞Ï°¥ Ï∂©Îèå Í∞ÄÎä•ÏÑ±Ïù¥ ÏûàÎäî ÎùºÏù¥Î∏åÎü¨Î¶¨Îì§ÏùÑ Ïãπ ÏßÄÏõÅÎãàÎã§.
!pip uninstall -y torch torchvision torchaudio triton ultralytics

# 2. Ìò∏ÌôòÎêòÎäî Î≤ÑÏ†ÑÏúºÎ°ú Îã§Ïãú ÍπîÎÅîÌïòÍ≤å ÏÑ§ÏπòÌï©ÎãàÎã§.
!pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
!pip install ultralytics mediapipe

# 3. ÌïúÍ∏Ä Ìè∞Ìä∏ (ÏãúÍ∞ÅÌôîÏö©)
!sudo apt-get install -y fonts-nanum
!rm ~/.cache/matplotlib -rf

"""# Í∂ÅÌï©"""

import cv2
import numpy as np
import matplotlib.pyplot as plt
from ultralytics import YOLO
import mediapipe as mp
from PIL import ImageFont, ImageDraw, Image
from google.colab import drive, files
import os
import math
import random
from IPython.display import display, HTML
import base64
from io import BytesIO

# 1. ÎØ∏ÎîîÏñ¥ÌååÏù¥ÌîÑ Î∞è ÎìúÎùºÏù¥Î∏å ÏÑ§Ï†ï
try:
    mp_hands = mp.solutions.hands
except AttributeError:
    print("üö® Ïò§Î•ò: Îü∞ÌÉÄÏûÑ Ïû¨ÏãúÏûëÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.")
    raise

if not os.path.exists('/content/drive'):
    drive.mount('/content/drive')

# =========================================================
# [V23.0] Ïª§Ìîå Í∂ÅÌï© Ìï¥ÏÑùÍ∏∞ (ÌíçÏÑ±Ìïú Love Tip & ÏΩòÌÖêÏ∏† Í∞ïÌôî)
# =========================================================
class CompatibilityInterpreter:
    def __init__(self):
        # 1. Î©îÏù∏ ÌÖçÏä§Ìä∏ DB (Í∏∞Ï°¥ Ïú†ÏßÄ - 2Ï†ê Îã®ÏúÑ Ï†ïÎ∞Ä Î∂ÑÏÑù)
        self.high_score_db = {
            # [90Ï†êÎåÄ]
            49: {'title': "ü¶Ñ Ï†ÑÏÑ§ ÏÜçÏùò Ïú†ÎãàÏΩò", 'desc': "Ïù¥Í±¥ ÏÇ¨ÎûåÏù¥ Îß∫ÏùÄ Ïù∏Ïó∞Ïù¥ ÏïÑÎãôÎãàÎã§. Ïö∞Ï£ºÍ∞Ä ÎèÑÏôîÎÑ§Ïöî. Ï†ÑÏÉùÏóê ÏµúÏÜå 3Î≤àÏùÄ Î∂ÄÎ∂ÄÏòÄÏùÑ Í≤ÅÎãàÎã§.", 'tag': "#Ïã†Í≥ÑÏòÅÏó≠ #Í∏∞Ï†Å #ÏôÑÎ≤ΩÍ∑∏ÏûêÏ≤¥"},
            48: {'title': "üëë ÏôïÍ≥º Ïó¨ÏôïÏùò ÎßåÎÇ®", 'desc': "ÏÑúÎ°úÎ•º ÎπõÎÇ¥Ï£ºÍ∏∞ ÏúÑÌï¥ ÌÉúÏñ¥ÎÇú Ï°¥Ïû¨Îì§ÏûÖÎãàÎã§. Í∞êÏ†ïÏÑ†Ïù¥ ÎßàÏπò Î≥µÏÇ¨Ìïú ÎìØ ÏùºÏπòÌï©ÎãàÎã§.", 'tag': "#ÌçºÌéôÌä∏Îß§Ïπò #ÏÜåÏö∏Î©îÏù¥Ìä∏"},
            47: {'title': "üíç Í≤∞ÌòºÏù¥ ÏãúÍ∏âÌï©ÎãàÎã§", 'desc': "Îçî Ïù¥ÏÉÅ Ïû¥ ÌïÑÏöîÎèÑ ÏóÜÏäµÎãàÎã§. ÎààÎπõÎßå Î¥êÎèÑ ÌÜµÌïòÎäî ÏÇ¨Ïù¥, ÎÜìÏπòÎ©¥ ÌèâÏÉù ÎïÖÏùÑ ÏπòÍ≥† ÌõÑÌöåÌï† Ïö¥Î™ÖÏûÖÎãàÎã§.", 'tag': "#Í≤∞ÌòºÍ∞Å #Ïö¥Î™Ö #ÌèâÏÉùÎÇ¥Ìé∏"},
            46: {'title': "üíû Ïã¨Ïû•Ïù¥ Î∞òÏùëÌïòÎäî ÏÇ¨Ïù¥", 'desc': "Î®∏Î¶¨Î°ú ÏÉùÍ∞ÅÌïòÍ∏∞ Ï†ÑÏóê Í∞ÄÏä¥Ïù¥ Î®ºÏ†Ä Î∞òÏùëÌï©ÎãàÎã§. ÏÑúÎ°úÏóêÍ≤å Í∞ÄÏû• Ìè¨Í∑ºÌïú ÏïàÏãùÏ≤òÍ∞Ä ÎêòÏñ¥Ï£ºÎäîÍµ∞Ïöî.", 'tag': "#Ïã¨Ïøµ #ÏïàÏãùÏ≤ò #ÌûêÎßÅ"},
            45: {'title': "üåπ Î°úÎß®Ïä§ ÏÜåÏÑ§ Ï£ºÏù∏Í≥µ", 'desc': "ÎìúÎùºÎßàÎÇò ÏòÅÌôîÏóêÏÑú Î≥¥Îçò ÏÇ¨ÎûëÏù¥ ÌòÑÏã§Ïù¥ ÎêòÏóàÏäµÎãàÎã§. Ï£ºÏúÑ ÏÇ¨ÎûåÎì§Ïù¥ Î∂ÄÎü¨ÏõåÌï† ÎßåÌÅº ÏòàÏÅú ÏÇ¨Îûë Ï§ëÏù¥ÎÑ§Ïöî.", 'tag': "#Î°úÎß®Ìã± #ÏÑ±Í≥µÏ†Å #ÏõåÎÑàÎπÑ"},
            # [80Ï†êÎåÄ]
            44: {'title': "üçØ Îã¨Îã¨Ìïú ÏñëÎ¥âÏóÖÏûê", 'desc': "ÎààÏóêÏÑú ÍøÄÏù¥ ÎöùÎöù Îñ®Ïñ¥ÏßëÎãàÎã§. ÏÑúÎ°úÏùò Îã®Ï†êÏ°∞Ï∞® Í∑ÄÏó¨Ïõå Î≥¥Ïù¥Îäî 'ÏΩ©ÍπçÏßÄ'Í∞Ä ÌèâÏÉù Í∞à Í∏∞ÏÑ∏ÏûÖÎãàÎã§.", 'tag': "#ÍøÄÎöùÎöù #ÏΩ©ÍπçÏßÄ #Îã¨Îã¨Ìï®"},
            43: {'title': "üç¨ ÏÜúÏÇ¨ÌÉï Í∞ôÏùÄ ÏÇ¨Îûë", 'desc': "Ìï®Íªò ÏûàÏúºÎ©¥ ÏÑ∏ÏÉÅÏù¥ Îã¨ÏΩ§Ìï¥ÏßëÎãàÎã§. Ïã∏ÏõåÎèÑ Í∏àÎ∞© ÌíÄÎ¶¨Í≥†, Îí§ÎÅù ÏóÜÏù¥ Íπ®ÎÅóÌïòÍ≥† ÎßëÏùÄ Ïó∞Ïï†Î•º ÌïòÍ≥† Í≥ÑÏãúÎÑ§Ïöî.", 'tag': "#Ïä§ÏúóÌï® #ÏàúÏàò #Ï≤≠Ï†ïÍµ¨Ïó≠"},
            42: {'title': "üîí Îã®Îã®Ìïú ÏûêÎ¨ºÏá†", 'desc': "ÌùîÎì§Î¶¨ÏßÄ ÏïäÎäî Ìé∏ÏïàÌï®! ÏÑúÎ°úÏóê ÎåÄÌïú Ïã†Î¢∞Í∞Ä Îß§Ïö∞ ÎëêÌÑ∞Ïõå Ïñ¥Îñ§ ÏãúÎ†®Ïù¥ ÏôÄÎèÑ ÎÅÑÎñ°ÏóÜÏùÑ Îã®Îã®Ìïú ÏÇ¨Ïù¥ÏûÖÎãàÎã§.", 'tag': "#Ïã†Î¢∞ #Íµ≥Í±¥Ìï® #ÎØøÏùå"},
            41: {'title': "üî• Î∂àÌÉÄÎäî Í∏àÏöîÏùº", 'desc': "Ïó¥Ï†ïÏù¥ ÎÑòÏπòÎäî Ïª§ÌîåÏûÖÎãàÎã§. Ìï®Íªò Î¨¥Ïñ∏Í∞ÄÎ•º Ìï† Îïå ÏóêÎÑàÏßÄÍ∞Ä Ìè≠Î∞úÌïòÎ©∞, ÏßÄÎ£®Ìï† ÌãàÏù¥ ÏóÜÎäî ÏùµÏÇ¨Ïù¥ÌåÖÌïú Í¥ÄÍ≥Ñ!", 'tag': "#Ïó¥Ï†ï #ÏóêÎÑàÏßÄ #ÌôúÎ†•ÏÜå"},
            40: {'title': "üß± Îì†Îì†Ìïú ÎÇ¥ Ìé∏", 'desc': "ÏÑ∏ÏÉÅ Î™®ÎëêÍ∞Ä Îì±ÏùÑ ÎèåÎ†§ÎèÑ Ïù¥ ÏÇ¨ÎûåÎßåÏùÄ ÎÇ¥ Ìé∏Ïù¥ ÎêòÏñ¥Ï§Ñ Í≤ÅÎãàÎã§. ÏïÑÏ£º ÏïàÏ†ïÏ†ÅÏù¥Í≥† Î™®Î≤îÏ†ÅÏù∏ Ïª§ÌîåÏùò Ï†ïÏÑùÏûÖÎãàÎã§.", 'tag': "#ÎÇ¥Ìé∏ #ÏïàÏ†ïÍ∞ê #Ï†ïÏÑù"},
            # [70Ï†êÎåÄ]
            39: {'title': "üå± ÏûêÎùºÎÇòÎäî ÏÉàÏãπ", 'desc': "ÏÑúÎ°úÍ∞Ä ÏÑúÎ°úÏùò ÏÑ±Ïû•ÏùÑ ÎèïÎäî 'ÎπÑÎ£å' Í∞ôÏùÄ Ï°¥Ïû¨ÏûÖÎãàÎã§. Ìï®ÍªòÌï†ÏàòÎ°ù Îçî Î©ãÏßÑ ÏÇ¨ÎûåÏù¥ ÎêòÏñ¥Í∞ÄÎäî ÏÉùÏÇ∞Ï†ÅÏù∏ Í¥ÄÍ≥Ñ!", 'tag': "#ÏÑ±Ïû•Ìòï #ÏúàÏúà #ÎØ∏ÎûòÏßÄÌñ•"},
            38: {'title': "üß© Îî± ÎßûÎäî ÌçºÏ¶ê", 'desc': "ÏÑ±Í≤©ÏùÄ Ï°∞Í∏à Îã§Î•ºÏßÄ Î™∞ÎùºÎèÑ, Í∞ÄÏπòÍ¥ÄÏù¥ Ïûò ÎßûÏäµÎãàÎã§. ÏÑúÎ°úÏùò ÎπàÌãàÏùÑ Í∏∞Í∞Ä ÎßâÌûàÍ≤å Ï±ÑÏõåÏ£ºÎäî ÏÉÅÌò∏Î≥¥ÏôÑÏ†Å Í¥ÄÍ≥ÑÏûÖÎãàÎã§.", 'tag': "#ÌçºÏ¶ê #ÏÉÅÌò∏Î≥¥ÏôÑ #Î∞∏Îü∞Ïä§"},
            37: {'title': "ü•Ç ÏÉ¥ÌéòÏù∏ Ïª§Ìîå", 'desc': "ÌÜ° ÏèòÎäî Îß§Î†•Ïù¥ ÏûàÏäµÎãàÎã§. Í∞ÄÎÅî ÏùòÍ≤¨ Ï∞®Ïù¥Í∞Ä ÏûàÏñ¥ÎèÑ ÎåÄÌôîÎ°ú Ïø®ÌïòÍ≤å ÌíÄÏñ¥ÎÇ¥Îäî ÏÑ±ÏàôÌï®ÏùÑ Í∞ñÏ∂îÍ≥† ÏûàÎÑ§Ïöî.", 'tag': "#Ïø®Ìï® #ÏÑ±Ïàô #Îß§Î†•"},
            36: {'title': "üé® Î¨ºÍ∞êÍ≥º Î∂ì", 'desc': "ÏÑúÎ°ú Îã§Î•∏ ÏÉâÍπîÏùÑ Í∞ÄÏ°åÏßÄÎßå, ÎëòÏù¥ ÎßåÎÇò ÏïÑÎ¶ÑÎã§Ïö¥ Í∑∏Î¶ºÏùÑ Í∑∏Î¶ΩÎãàÎã§. Îã§Î¶ÑÏùÑ Ïù∏Ï†ïÌïòÍ≥† Ï¶êÍ∏∏ Ï§Ñ ÏïÑÎäî Î©ãÏßÑ Ïª§Ìîå.", 'tag': "#Ï°∞Ìôî #ÏòàÏà† #Ïª¨Îü¨ÌíÄ"},
            35: {'title': "üëü Ìé∏ÏïàÌïú Ïö¥ÎèôÌôî", 'desc': "Ïò§Îûò Ïã†ÏùÄ Ïã†Î∞úÏ≤òÎüº Ìé∏ÏïàÌï©ÎãàÎã§. Í≤©Ïãù Ï∞®Î¶¥ ÌïÑÏöî ÏóÜÏù¥ Í∞ÄÏû• 'ÎÇòÎã§Ïö¥ Î™®Ïäµ'ÏùÑ Î≥¥Ïó¨Ï§Ñ Ïàò ÏûàÎäî Î≤†Ïä§Ìä∏ ÌîÑÎ†åÎìú.", 'tag': "#Î≤†ÌîÑ #Ìé∏ÏïàÌï® #ÏûêÏó∞Ïä§Îü¨ÏõÄ"}
        }
        self.default_text = {
            'title': "‚ö° ÏßúÎ¶øÌïú Ïä§ÌååÌÅ¨", 'desc': "ÏÑúÎ°ú ÎÑàÎ¨¥ Îã¨ÎùºÏÑú ÎØ∏Ïπú ÎìØÏù¥ ÎÅåÎ¶¨Îäî ÏûêÏÑù Í∞ôÏùÄ ÏÇ¨Ïù¥! Îß§ÏùºÎß§ÏùºÏù¥ ÏòàÏ∏°Î∂àÌóàÏù∏ Ïä§ÌéôÌÑ∞ÌÅ¥Ìïú Î°úÎß®Ïä§ÏûÖÎãàÎã§.", 'tag': "#Î∞òÏ†ÑÎß§Î†• #ÏûêÏÑù #Îã¨ÏΩ§ÏÇ¥Î≤å"
        }

        # 2. [NEW] Love Tip Ïã¨Ìôî DB (Ï†êÏàò Íµ¨Í∞ÑÎ≥Ñ Ï∂îÏ≤ú)
        self.tips_db = {
            'tier_1': [ # 90Ï†ê Ïù¥ÏÉÅ (ÏÜåÏö∏Î©îÏù¥Ìä∏/Í≤∞Ìòº)
                {'mission': "ÏÑúÎ°úÏùò ÎØ∏Îûò ÏùºÍ∏∞ Ïç®Ï£ºÍ∏∞ (1ÎÖÑ Îí§ Ïò§Îäò)", 'item': "Ïù¥ÎãàÏÖúÏù¥ ÏÉàÍ≤®ÏßÑ Ïª§ÌîåÎßÅ ÎòêÎäî Í∞ÅÏù∏ ÌåîÏ∞å", 'place': "ÌîÑÎùºÏù¥ÎπóÌïú Ìò∏Ï∫âÏä§ÎÇò Ï°∞Ïö©Ìïú ÏôÄÏù∏Î∞î"},
                {'mission': "ÎààÏùÑ 1Î∂ÑÍ∞Ñ Î∞îÎùºÎ≥¥Î©∞ ÏÇ¨ÎûëÌïúÎã§Í≥† ÎßêÌïòÍ∏∞", 'item': "Îëê Î∂ÑÏùò Ï∂îÏñµÏù¥ Îã¥Í∏¥ Ìè¨ÌÜ†Î∂Å Ï†úÏûë", 'place': "ÏïºÍ≤ΩÏù¥ ÌïúÎààÏóê Î≥¥Ïù¥Îäî Ï†ÑÎßùÎåÄ"},
                {'mission': "ÏÑúÎ°úÏùò Î∞ú ÏîªÍ≤®Ï£ºÍ∏∞ (ÏÑ∏Ï°±Ïãù)", 'item': "Í∞ôÏùÄ Ìñ•ÏùÑ Í≥µÏú†ÌïòÎäî Ïª§Ìîå Ìñ•Ïàò", 'place': "ÎëòÎßåÏùò Ïò§Î∂ìÌïú Í∏ÄÎû®ÌïëÏû•"},
                {'mission': "Ìï®Íªò ÌÜµÏû• Í∞úÏÑ§ÌïòÍ±∞ÎÇò Ïû¨ÌÖåÌÅ¨ Í≥ÑÌöç ÏÑ∏Ïö∞Í∏∞", 'item': "Ïû†Ïò∑(ÌååÏûêÎßà) ÏÑ∏Ìä∏ ÎßûÏ∂∞ ÏûÖÍ∏∞", 'place': "Î∂ÑÏúÑÍ∏∞ Ï¢ãÏùÄ Ïû¨Ï¶àÎ∞î"}
            ],
            'tier_2': [ # 80Ï†êÎåÄ (Îã¨Îã¨Ìï®/ÏïàÏ†ï)
                {'mission': "ÏÑúÎ°úÏóêÍ≤å Ïñ¥Ïö∏Î¶¨Îäî Ïò∑ Í≥®ÎùºÏ£ºÍ∏∞", 'item': "Í∑ÄÏó¨Ïö¥ Ïª§Ìîå Ìè∞ÏºÄÏù¥Ïä§", 'place': "ÎÜÄÏù¥Í≥µÏõê ÍµêÎ≥µ Îç∞Ïù¥Ìä∏"},
                {'mission': "ÎèÑÏãúÎùΩ Ïã∏ÏÑú ÌîºÌÅ¨Îãâ Í∞ÄÍ∏∞", 'item': "Ïª§Ìîå Ïö¥ÎèôÌôî (Ïä§ÎãàÏª§Ï¶à)", 'place': "ÌïúÍ∞ï Í≥µÏõê ÌÖêÌä∏ Îç∞Ïù¥Ìä∏"},
                {'mission': "Ìï®Íªò ÏöîÎ¶¨Ìï¥ÏÑú Ï†ÄÎÖÅ Î®πÍ∏∞", 'item': "ÏÑúÎ°úÏùò ÌÉÑÏÉùÏÑùÏù¥ Îì§Ïñ¥Í∞Ñ ÌÇ§ÎßÅ", 'place': "Ïø†ÌÇπ ÌÅ¥ÎûòÏä§ ÎòêÎäî ÎèÑÏûêÍ∏∞ Í≥µÎ∞©"},
                {'mission': "ÎÑ§ Ïª∑ ÏÇ¨ÏßÑ Ï∞çÏúºÎ©∞ ÏóΩÍ∏∞ ÌëúÏ†ï ÏßìÍ∏∞", 'item': "Îß®Ìà¨Îß® Ìã∞ÏÖîÏ∏† ÏãúÎ∞ÄÎü¨Î£©", 'place': "ÌûôÌïú ÏÑ±ÏàòÎèô Ïπ¥Ìéò Ìà¨Ïñ¥"}
            ],
            'tier_3': [ # 70Ï†êÎåÄ (ÏπúÍµ¨/ÏÑ±Ïû•)
                {'mission': "Î∞§ÏÉàÎèÑÎ°ù Ïà† ÌïúÏûîÌïòÎ©∞ ÏßÑÏßÄÌïú ÎåÄÌôîÌïòÍ∏∞", 'item': "Ïª§Ìîå Î™®Ïûê (Î≥ºÏ∫°/ÎπÑÎãà)", 'place': "Ï°∞Ïö©Ìïú Î£∏ Ïù¥ÏûêÏπ¥Ïïº"},
                {'mission': "ÏÑúÎ°úÏùò Ï∑®ÎØ∏ ÏÉùÌôú ÌïòÎ£® ÎèôÏïà Í∞ôÏù¥ Ìï¥Î≥¥Í∏∞", 'item': "Î∏îÎ£®Ìà¨Ïä§ Ïù¥Ïñ¥Ìè∞ ÏºÄÏù¥Ïä§ ÏÑ∏Ìä∏", 'place': "Ìï®Íªò ÎïÄ ÌùòÎ¶¨Îäî Îì±ÏÇ∞Ïù¥ÎÇò ÌÅ¥ÎùºÏù¥Î∞ç"},
                {'mission': "ÏÑúÎ°úÏóêÍ≤å Ï∂îÏ≤úÌïòÍ≥† Ïã∂ÏùÄ Ï±Ö ÏÑ†Î¨ºÌïòÍ∏∞", 'item': "Ïä§ÎßàÌä∏ÏõåÏπò Ïä§Ìä∏Îû© ÎßûÏ∂îÍ∏∞", 'place': "ÎåÄÌòï ÏÑúÏ†ê Îç∞Ïù¥Ìä∏"},
                {'mission': "ÎßõÏßë Ïõ®Ïù¥ÌåÖ Í∏∞Îã§Î¶¨Î©∞ ÏàòÎã§ Îñ®Í∏∞", 'item': "Ïª§Ìîå ÌÖÄÎ∏îÎü¨", 'place': "Ï§Ñ ÏÑúÏÑú Î®πÎäî Ìï´ÌîåÎ†àÏù¥Ïä§ ÎßõÏßë"}
            ],
            'tier_4': [ # Í∑∏ Ïô∏ (Ïä§ÌååÌÅ¨/Ïù¥ÏÉâ)
                {'mission': "Î∞©ÌÉàÏ∂ú Í≤åÏûÑÏóêÏÑú ÌòëÎèôÏã¨ Í∏∞Î•¥Í∏∞", 'item': "Ïû¨ÎØ∏ÏûàÎäî Î¨∏Íµ¨Í∞Ä Ï†ÅÌûå Ìã∞ÏÖîÏ∏†", 'place': "Í≥µÌè¨ ÌÖåÎßà Î∞©ÌÉàÏ∂ú Ïπ¥Ìéò"},
                {'mission': "ÏÑúÎ°úÏùò MBTI Î∂ÑÏÑùÌï¥Ï£ºÍ∏∞", 'item': "ÌïÑÎ¶Ñ Ïπ¥Î©îÎùº (ÏÑúÎ°ú Ï∞çÏñ¥Ï£ºÍ∏∞)", 'place': "Î†àÌä∏Î°ú Í∞êÏÑ± Î°§Îü¨Ïû•"},
                {'mission': "ÎÖ∏ÎûòÎ∞© Í∞ÄÏÑú Ïä§Ìä∏Î†àÏä§ ÌíÄÍ∏∞", 'item': "Ïª§Ìîå ÏÑ†Í∏ÄÎùºÏä§", 'place': "VR ÌÖåÎßàÌååÌÅ¨ ÎòêÎäî Ïò§ÎùΩÏã§"},
                {'mission': "Îß§Ïö¥ ÏùåÏãù Î®πÏúºÎ©∞ ÎïÄ ÎπºÍ∏∞", 'item': "Ïä§Ìè¨Ï∏† ÌÉÄÏõî ÏÑ∏Ìä∏", 'place': "Ïä§Ìä∏Î†àÏä§ ÌíÄÎ¶¨Îäî Îß§Ïö¥ Í∞àÎπÑÏ∞ú ÎßõÏßë"}
            ]
        }

    def calculate_match(self, feat1, feat2):
        # ÏïåÍ≥†Î¶¨Ï¶ò Ïú†ÏßÄ
        diff_curv = abs(feat1['curv'] - feat2['curv'])
        diff_len  = abs(feat1['len_ratio'] - feat2['len_ratio'])
        diff_slope= abs(feat1['slope'] - feat2['slope'])

        s_curv = 100 * math.exp(-diff_curv * 2.5)
        s_len  = 100 * math.exp(-diff_len * 2.0)
        s_slope= 100 * math.exp(-diff_slope * 1.0)

        data_score = (s_curv * 0.5) + (s_len * 0.3) + (s_slope * 0.2)
        data_score = data_score * 1.1

        fate_score = random.randint(70, 99)
        final_score = (data_score * 0.7) + (fate_score * 0.3)

        final_score = int(final_score)
        if final_score > 99: final_score = 99
        if final_score < 1: final_score = 1
        return final_score

    def get_result_html(self, score):
        # 1. Î©îÏù∏ ÌÖçÏä§Ìä∏ Í≤∞Ï†ï
        if score >= 70:
            key = score // 2
            data = self.high_score_db.get(key, self.high_score_db[35])
        else:
            data = self.default_text

        # 2. ÌåÅ Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤∞Ï†ï
        if score >= 90: tier = 'tier_1'
        elif score >= 80: tier = 'tier_2'
        elif score >= 70: tier = 'tier_3'
        else: tier = 'tier_4'

        # 3. ÌåÅ ÎûúÎç§ ÏÑ†ÌÉù
        tip_data = random.choice(self.tips_db[tier])

        # HTML Íµ¨ÏÑ±
        html = f"""
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Gamja+Flower&family=Noto+Sans+KR:wght@300;500;700&display=swap');

            .couple-container {{
                max-width: 500px; margin: 0 auto;
                font-family: 'Noto Sans KR', sans-serif;
                animation: fadeUp 1.2s ease-out;
            }}

            .couple-card {{
                background: white;
                border-radius: 40px;
                padding: 40px 30px;
                box-shadow: 0 20px 50px rgba(255, 105, 180, 0.15);
                text-align: center;
                border: 1px solid rgba(255, 230, 230, 0.8);
                position: relative; overflow: hidden;
            }}

            .deco-circle {{
                position: absolute; width: 180px; height: 180px;
                background: radial-gradient(circle, rgba(255,200,200,0.4) 0%, rgba(255,255,255,0) 70%);
                top: -50px; right: -50px; border-radius: 50%; z-index: 0;
            }}

            .main-content {{ position: relative; z-index: 1; }}

            .score-title {{ font-size: 1.0em; color: #aaa; letter-spacing: 3px; margin-bottom: 5px; }}
            .score-val {{
                font-size: 6.5em; font-weight: 800;
                background: linear-gradient(120deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
                -webkit-background-clip: text; -webkit-text-fill-color: transparent;
                margin: -10px 0; font-family: 'Gamja Flower', cursive;
                filter: drop-shadow(2px 2px 5px rgba(255,100,100,0.1));
            }}

            .result-title {{
                font-size: 1.8em; font-weight: 700; color: #444; margin-top: 10px;
                font-family: 'Gamja Flower', cursive;
            }}

            .tags {{ margin: 15px 0; }}
            .tag-pill {{
                display: inline-block; background: #fff0f6; color: #d63384;
                padding: 5px 12px; border-radius: 15px; font-size: 0.85em; margin: 2px;
            }}

            .desc-area {{
                margin-top: 20px; padding: 20px;
                background: #fafafa; border-radius: 15px;
                color: #666; line-height: 1.6; font-size: 1.0em;
                text-align: left;
            }}

            /* --- V23.0 Love Tip Section Design --- */
            .tip-container {{
                margin-top: 25px;
                background: linear-gradient(135deg, #fff5f7 0%, #fff 100%);
                border-radius: 20px;
                padding: 20px;
                border: 2px dashed #ffccd5;
                text-align: left;
            }}
            .tip-header {{
                font-family: 'Gamja Flower', cursive;
                font-size: 1.4em; color: #ff6b81; margin-bottom: 15px;
                text-align: center; font-weight: bold;
            }}
            .tip-item {{
                margin-bottom: 12px; display: flex; align-items: flex-start;
            }}
            .tip-icon {{
                min-width: 30px; font-size: 1.2em; margin-right: 8px; text-align: center;
            }}
            .tip-content {{
                font-size: 0.95em; color: #555; word-break: keep-all; line-height: 1.4;
            }}
            .tip-content b {{ color: #d63031; }}

            @keyframes fadeUp {{ from {{ opacity: 0; transform: translateY(20px); }} to {{ opacity: 1; transform: translateY(0); }} }}
        </style>

        <div class="couple-container">
            <div class="couple-card">
                <div class="deco-circle"></div>
                <div class="main-content">
                    <div class="score-title">COMPATIBILITY</div>
                    <div class="score-val">{score}%</div>

                    <div class="result-title">{data['title']}</div>

                    <div class="tags">
                        {' '.join([f'<span class="tag-pill">{t}</span>' for t in data['tag'].split()])}
                    </div>

                    <div class="desc-area">
                        {data['desc']}
                    </div>

                    <div class="tip-container">
                        <div class="tip-header">üíò Ïò§ÎäòÏùò Ï∂îÏ≤ú Î†àÏãúÌîº</div>

                        <div class="tip-item">
                            <div class="tip-icon">üìù</div>
                            <div class="tip-content"><b>Mission:</b> {tip_data['mission']}</div>
                        </div>
                        <div class="tip-item">
                            <div class="tip-icon">üéÅ</div>
                            <div class="tip-content"><b>Item:</b> {tip_data['item']}</div>
                        </div>
                        <div class="tip-item">
                            <div class="tip-icon">üìç</div>
                            <div class="tip-content"><b>Place:</b> {tip_data['place']}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        """
        return html

# =========================================================
# Ïª§Ìîå Î∂ÑÏÑù ÏãúÍ∞ÅÌôî ÌÅ¥ÎûòÏä§ (V22ÏôÄ ÎèôÏùº, ÏÇ¨ÏßÑ Ïï°Ïûê Í∏∞Îä• Ìè¨Ìï®)
# =========================================================
class CoupleAnalysisVisualizer:
    def __init__(self, model_path):
        print(f"‚úÖ [Ïª§Ìîå Îß§Ïπ≠ V23.0 Ultimate] Î™®Îç∏ Î°úÎî© Ï§ë: {os.path.basename(model_path)}")
        self.model = YOLO(model_path)
        self.interpreter = CompatibilityInterpreter()
        self.mp_hands = mp.solutions.hands
        self.hands = self.mp_hands.Hands(static_image_mode=True, max_num_hands=1)
        self.target_line_id = 2

    def process_single_image(self, image_path):
        origin_img = cv2.imread(image_path)
        if origin_img is None: return None, None
        img_rgb = cv2.cvtColor(origin_img, cv2.COLOR_BGR2RGB)
        mp_results = self.hands.process(img_rgb)
        height, width = origin_img.shape[:2]
        hand_len = height * 0.5

        if mp_results.multi_hand_landmarks:
            lm = mp_results.multi_hand_landmarks[0].landmark
            p0 = np.array([lm[0].x * width, lm[0].y * height])
            p9 = np.array([lm[9].x * width, lm[9].y * height])
            hand_len = np.linalg.norm(p9 - p0)

        lab = cv2.cvtColor(origin_img, cv2.COLOR_BGR2LAB)
        l, a, b = cv2.split(lab)
        clahe = cv2.createCLAHE(clipLimit=2.0, tileGridSize=(8, 8))
        ai_input = cv2.cvtColor(cv2.merge((clahe.apply(l), a, b)), cv2.COLOR_LAB2BGR)

        results = self.model.predict(ai_input, conf=0.05, verbose=False)
        best_conf = 0; best_kpts = None

        if results and results[0].keypoints is not None:
            kpts_all = results[0].keypoints.xy.cpu().numpy()
            clses = results[0].boxes.cls.cpu().numpy()
            confs = results[0].boxes.conf.cpu().numpy()
            for idx, cls_id in enumerate(clses):
                if int(cls_id) == self.target_line_id:
                    if confs[idx] > best_conf:
                        best_conf = confs[idx]; best_kpts = kpts_all[idx]

        canvas_img = origin_img.copy(); features = None
        if best_kpts is not None:
            points = np.array([(int(x), int(y)) for x, y in best_kpts if x > 0])
            if len(points) > 1:
                cv2.polylines(canvas_img, [points], False, (180, 105, 255), 10, cv2.LINE_AA)
                cv2.polylines(canvas_img, [points], False, (255, 255, 255), 3, cv2.LINE_AA)
                curve_len = np.sum(np.sqrt(np.sum(np.diff(points, axis=0)**2, axis=1)))
                euclidean = np.linalg.norm(points[-1] - points[0])
                vec = points[-1] - points[0]
                slope = vec[1] / (vec[0] + 1e-6)
                features = {'len_ratio': curve_len / hand_len, 'curv': curve_len / (euclidean + 1e-6), 'slope': slope}

        return canvas_img, features

    def _img_to_base64(self, img):
        img_pil = Image.fromarray(cv2.cvtColor(img, cv2.COLOR_BGR2RGB))
        buffered = BytesIO()
        img_pil.save(buffered, format="JPEG", quality=90)
        img_str = base64.b64encode(buffered.getvalue()).decode()
        return img_str

    def display_framed_photos(self, img1, img2):
        img1_b64 = self._img_to_base64(img1)
        img2_b64 = self._img_to_base64(img2)

        html = f"""
        <style>
            .photo-container {{ display: flex; justify-content: center; gap: 20px; margin: 30px 0; }}
            .photo-frame {{
                background: #fff; padding: 10px; border-radius: 20px;
                box-shadow: 0 10px 20px rgba(0,0,0,0.1); text-align: center;
                border: 2px solid #ffebee; width: 45%; max-width: 200px;
            }}
            .photo-frame img {{
                width: 100%; height: auto; aspect-ratio: 1/1; object-fit: cover;
                border-radius: 15px; border: 2px solid #ffcdd2;
            }}
            .photo-label {{
                margin-top: 10px; font-family: 'Gamja Flower', cursive; color: #ff8a80; font-size: 1.2em; font-weight: bold;
            }}
            .heart-divider {{ font-size: 2em; align-self: center; color: #ff6b81; animation: beat 1s infinite; }}
            @keyframes beat {{ 0% {{ transform: scale(1); }} 50% {{ transform: scale(1.2); }} 100% {{ transform: scale(1); }} }}
        </style>
        <div class="photo-container">
            <div class="photo-frame">
                <img src="data:image/jpeg;base64,{img1_b64}">
                <div class="photo-label">Person A</div>
            </div>
            <div class="heart-divider">üíñ</div>
            <div class="photo-frame">
                <img src="data:image/jpeg;base64,{img2_b64}">
                <div class="photo-label">Person B</div>
            </div>
        </div>
        """
        display(HTML(html))

    def compare_couples(self, file_list):
        if len(file_list) < 2: return
        print(f"üíû Ïª§Ìîå Î∂ÑÏÑù ÏßÑÌñâ Ï§ë... Îëê Î∂ÑÏùò ÏÜêÏùÑ ÎßûÎåÄÏñ¥ Î¥ÖÎãàÎã§...")
        img1, feat1 = self.process_single_image(file_list[0])
        img2, feat2 = self.process_single_image(file_list[1])

        if feat1 is None or feat2 is None:
            print("‚ùå Ïò§Î•ò: Í∞êÏ†ïÏÑ†ÏùÑ Ï∞æÏßÄ Î™ªÌñàÏäµÎãàÎã§.")
            return

        self.display_framed_photos(img1, img2)

        match_score = self.interpreter.calculate_match(feat1, feat2)
        html_report = self.interpreter.get_result_html(match_score)
        display(HTML(html_report))

# ==========================================
# Ïã§Ìñâ
# ==========================================
BASE_PATH = '/content/drive/MyDrive/final_pro/mobileNet'
MODEL_FILE = 'num_02.pt'
model_path = os.path.join(BASE_PATH, MODEL_FILE)

if os.path.exists(model_path):
    vis = CoupleAnalysisVisualizer(model_path)
    file_list = []
    print("\n" + "="*50)
    print("üë§ [1Îã®Í≥Ñ] Î≥∏Ïù∏(Person A)Ïùò ÏÜêÎ∞îÎã• ÏÇ¨ÏßÑÏùÑ ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî.")
    print("="*50)
    uploaded_1 = files.upload()
    if uploaded_1:
        file_list.append(list(uploaded_1.keys())[0])
        print("‚úÖ 1Îã®Í≥Ñ ÏôÑÎ£å!\n")
        print("="*50)
        print("‚ù§Ô∏è [2Îã®Í≥Ñ] ÏÉÅÎåÄÎ∞©(Person B)Ïùò ÏÜêÎ∞îÎã• ÏÇ¨ÏßÑÏùÑ ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî.")
        print("="*50)
        uploaded_2 = files.upload()
        if uploaded_2:
            file_list.append(list(uploaded_2.keys())[0])
            print("‚úÖ 2Îã®Í≥Ñ ÏôÑÎ£å! Í≤∞Í≥º Í≥ÑÏÇ∞ Ï§ë...\n")
            vis.compare_couples(file_list)
        else: print("‚ùå ÏÉÅÎåÄÎ∞© ÏÇ¨ÏßÑÏù¥ ÏóÜÏäµÎãàÎã§.")
    else: print("‚ùå Î≥∏Ïù∏ ÏÇ¨ÏßÑÏù¥ ÏóÜÏäµÎãàÎã§.")
else:
    print(f"‚ùå Î™®Îç∏ ÏóÜÏùå: {model_path}")