# -*- coding: utf-8 -*-
"""hand_line.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Puv1SWMKsF9LHA9aBp8cS0S9JhemvNVZ

# 환경설정
"""

# =========================================================
# [1단계] 라이브러리 설치 및 런타임 강제 재시작
# =========================================================
import os

print("1. 필수 라이브러리 설치 중...")
!pip uninstall mediapipe -y
!pip install mediapipe==0.10.14

print("2. 한글 폰트 설치 중...")
!sudo apt-get install -y fonts-nanum
!sudo fc-cache -fv
!rm ~/.cache/matplotlib -rf

print("✅ 설치 완료. 런타임을 강제로 재시작합니다...")
print("⚠️ 잠시 후 '세션이 다운되었습니다' 경고가 뜨면 정상이니 닫고 [2단계]를 실행하세요.")

# 1. YOLO(ultralytics) 및 MediaPipe 설치
!pip install ultralytics mediapipe

# 2. 한글 폰트 설치 (시각화에 필요)
!sudo apt-get install -y fonts-nanum
!sudo fc-cache -fv
!rm ~/.cache/matplotlib -rf

print("✅ 모든 라이브러리 설치가 완료되었습니다.")

# 1. 기존 충돌 가능성이 있는 라이브러리들을 싹 지웁니다.
!pip uninstall -y torch torchvision torchaudio triton ultralytics

# 2. 호환되는 버전으로 다시 깔끔하게 설치합니다.
!pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
!pip install ultralytics mediapipe

# 3. 한글 폰트 (시각화용)
!sudo apt-get install -y fonts-nanum
!rm ~/.cache/matplotlib -rf

import cv2
import numpy as np
import matplotlib.pyplot as plt
from ultralytics import YOLO
import mediapipe as mp
from PIL import ImageFont, ImageDraw, Image
from google.colab import drive, files
import os
import math
import random
from IPython.display import display, HTML

# 1. 미디어파이프 및 드라이브 설정
try:
    mp_hands = mp.solutions.hands
except AttributeError:
    print("🚨 오류: 런타임 재시작이 필요합니다.")
    raise

if not os.path.exists('/content/drive'):
    drive.mount('/content/drive')

# =========================================================
# AI 베테랑 역술가: 해석 엔진 (최종 통합: M자 로직 + 풀옵션 텍스트)
# =========================================================
class PalmInterpreter:
    def __init__(self):
        # 1. 기준값
        self.TH = {
            'gap': [0.01, 0.03, 0.05, 0.07, 0.10, 0.13, 0.18],
            'life_len': [0.30, 0.38, 0.44, 0.50, 0.56, 0.62, 0.70],
            'curv': [1.02, 1.05, 1.09, 1.14, 1.20],
            'slope': [0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.8]
        }

        # 2. 텍스트 데이터베이스 (풍부한 내용 + 바넘효과 + 랜덤성 100% 복구)
        self.texts = {
            'intro': [
                "어서 오십시오. 손바닥을 보니, 남들에게는 말 못 할 고민과 당신만의 뜨거운 열망이 동시에 느껴지는군요.",
                "손금은 단순한 주름이 아닙니다. 당신이 살아온 치열한 흔적이자, 앞으로 펼쳐질 운명의 설계도입니다.",
                "사람의 얼굴이 다 다르듯, 손금 또한 우주에서 유일무이합니다. 지금 당신의 손에는 위기 속에서도 기회를 찾아내는 비범한 잠재력이 숨어 있습니다."
            ],
            # --- [생명선] ---
            'life_start': {
                'glue': [
                    "🔒 <b>[신중한 완벽주의자]</b><br>돌다리도 두드려 보고 건너는 신중함을 타고났습니다. '실패하면 어떡하지?'라는 걱정이 많지만, 그 꼼꼼함 덕분에 큰 실수를 하지 않는 듬직한 사람입니다.",
                    "🐢 <b>[대기만성형 거북이]</b><br>시작은 다소 늦을 수 있으나, 한 번 발동이 걸리면 무섭게 치고 나갑니다. 초반의 신중함이 훗날의 실패를 막아주는 강력한 방패가 됩니다."
                ],
                'tight': [
                    "👀 <b>[배려심 깊은 평화주의자]</b><br>남의 눈치를 조금 보는 편입니다. 배려심이 깊어 '착한 사람' 소리를 듣지만, 본인의 속마음은 꾹꾹 눌러담느라 답답할 때가 있죠?",
                    "🕊️ <b>[평화를 사랑하는 중재자]</b><br>다툼을 싫어하고 조화를 중요시합니다. 조직 내에서 갈등을 조율하는 능력이 탁월하지만, 가끔은 본인의 이익도 챙겨야 합니다."
                ],
                'normal_tight': [
                    "🛡️ <b>[외유내강형]</b><br>안전지향적이지만 확신이 서면 과감하게 밀고 나가는 스타일입니다. 겉은 부드러워 보이지만 속은 단단한 바위 같습니다.",
                    "🎋 <b>[유연한 대나무]</b><br>바람에 흔들릴지언정 꺾이지 않는 유연함이 있습니다. 원칙을 지키되 상황에 맞춰 대처하는 능력이 뛰어납니다."
                ],
                'normal': [
                    "⚖️ <b>[처세술의 달인]</b><br>가장 이상적인 밸런스입니다! 독립심과 협동심이 황금비율을 이루고 있군요. 적을 만들지 않으면서도 실속을 챙길 줄 아는 사회생활 만렙입니다.",
                    "🤝 <b>[최고의 파트너]</b><br>리더십과 팔로워십을 동시에 갖췄습니다. 어디를 가든 환영받는 성격이며, 사람을 다루는 기술이 타고났습니다."
                ],
                'normal_loose': [
                    "🏃 <b>[자수성가의 싹]</b><br>부모님 품을 일찍 떠나거나 스스로의 힘으로 서려는 독립심이 강합니다. 누군가에게 기대기보다 내가 직접 성취했을 때 희열을 느낍니다.",
                    "🧗 <b>[도전하는 개척자]</b><br>남들이 가지 않는 길에 흥미를 느낍니다. 안정된 직장보다 내 사업이나 새로운 프로젝트를 맡았을 때 눈이 반짝이는군요."
                ],
                'loose': [
                    "🦅 <b>[자유로운 영혼]</b><br>남들이 '예'라고 할 때 '아니오'라고 말할 수 있는 용기가 있습니다. 사회의 틀에 얽매이기보다 내 방식대로 삶을 개척하려는 배짱이 당신의 무기입니다.",
                    "🌪️ <b>[바람 같은 자유인]</b><br>구속받는 것을 병적으로 싫어합니다. 프리랜서나 예체능처럼 자유로운 환경에서 일할 때 능력이 200% 발휘됩니다."
                ],
                'free': [
                    "🚀 <b>[시대를 앞서가는 혁신가]</b><br>와우, 완전히 분리된 KY선! 스티브 잡스 같은 혁신가들의 손금입니다. 남들은 이해 못 할 독창적인 생각과 과감한 결단력으로 세상을 놀라게 할 운명입니다.",
                    "👽 <b>[비범한 천재성]</b><br>평범함을 거부합니다. 때로는 '특이하다'는 소리를 듣지만, 그것이 바로 당신이 성공할 수 있는 핵심 경쟁력입니다."
                ]
            },
            'life_length_book': {
                'long': "🧬 <b>[축복받은 장수운]</b><br>생명선이 손목까지 시원하게 뻗었습니다. 타고난 면역력이 강해 잔병치레를 하더라도 금방 털고 일어나는 '오뚝이' 같은 회복력을 지녔습니다.",
                'middle': "🏃 <b>[균형 잡힌 웰빙 라이프]</b><br>생명선이 손목 위쪽에서 깔끔하게 마무리됩니다. 무리하지 않고 자신의 페이스를 조절할 줄 아는 현명함이 보입니다.",
                'short': "⚠️ <b>[짧고 굵은 불꽃]</b><br>수명이 짧다기보다 에너지를 한 번에 몰아서 쓰는 '단기 집중형'입니다. 열정이 넘쳐 몸을 혹사시키는 경향이 있으니, 쉼표를 찍는 연습이 필요합니다."
            },
            'life_curve_book': {
                'big': "💪 <b>[지치지 않는 에너자이저]</b><br>금성구가 매우 발달하여 가만히 있으면 병이 나는 스타일입니다. 육체적, 정신적 에너지가 차고 넘쳐 성공의 밑거름이 됩니다.",
                'moderate': "🌿 <b>[외유내강의 정석]</b><br>겉으로는 온화해 보이지만 내면에는 단단한 심지가 있습니다. 일할 땐 열정적이지만 쉴 때는 확실히 쉬는, 워라밸을 아는 현명한 사람입니다.",
                'small': "🍃 <b>[섬세한 감수성]</b><br>타고난 체력이 강한 편은 아니기에 쉽게 피로를 느낄 수 있습니다. 육체노동보다는 머리와 감성을 쓰는 분야에서 두각을 나타낼 것입니다."
            },
            'life_direction_book': {
                'thumb': "🏠 <b>[가정이 1순위]</b><br>생명선 끝이 엄지 쪽으로 감깁니다. 당신에게 가장 중요한 가치는 '가족'과 '안정'입니다. 말년에는 가족들의 사랑과 존경을 받으며 따뜻한 노후를 보낼 것입니다.",
                'wrist': "🌲 <b>[안정을 택하는 나무]</b><br>곧게 떨어지는 선은 모험보다는 확실한 안정을 선호함을 뜻합니다. 익숙한 환경에서 꾸준하게 성과를 내며, 고독을 즐길 줄 아는 깊이 있는 사람입니다.",
                'pinky': "✈️ <b>[세계를 누비는 역마살]</b><br>생명선 끝이 바깥으로 뻗어 나갑니다. 한곳에 머물면 좀이 쑤시는군요! 이사, 이직, 해외 생활 등 끊임없이 새로운 환경을 찾아다니며 성공할 운명입니다."
            },

            # --- [두뇌선] ---
            'head_length_book': {
                'long': "🐢 <b>[깊이 생각하는 철학자]</b><br>생각의 꼬리가 깁니다. 돌발 상황에서도 즉흥적으로 행동하기보다, 모든 경우의 수를 계산한 뒤 움직이는 전략가입니다.",
                'short': "⚡ <b>[직관이 번뜩이는 승부사]</b><br>\"이거다!\" 싶으면 앞뒤 재지 않고 바로 실행에 옮기는 행동파입니다. 복잡한 이론보다 직관을 믿으며, 순발력이 대단합니다."
            },
            'head_shape_book': {
                'straight': [
                    "📏 <b>[현실적인 분석가]</b><br>당신은 감정보다는 사실(Fact)을 중요하게 생각합니다. 겉으로는 차가워 보일 수 있지만, 사실은 누구보다 합리적으로 상황을 해결하여 주변 사람들을 보호하려는 책임감이 강합니다.",
                    "📐 <b>[냉철한 설계자]</b><br>복잡한 문제를 만났을 때 감정에 휘둘리기보다 논리적으로 분해하여 해결책을 찾습니다. 가끔 '너무 계산적이다'라는 오해를 받기도 하지만, 당신의 정확한 판단력은 위기 상황에서 빛을 발합니다.",
                    "⚖️ <b>[객관적인 관찰자]</b><br>당신은 뜨거운 가슴보다는 차가운 머리를 믿는 편이군요. 주관적인 느낌보다는 객관적인 데이터를 신뢰하며, 실수를 용납하지 않는 꼼꼼함이 당신의 가장 큰 무기입니다."
                ],
                'gentle': [
                    "🌊 <b>[유연한 사고의 소유자]</b><br>논리와 직관 사이에서 줄타기를 아주 잘하는군요. 현실적인 감각을 유지하면서도 타인의 감정을 읽어내는 센스까지 갖추고 있어, 어떤 상황에서도 유연하게 대처합니다.",
                    "🤝 <b>[이성과 감성의 황금비율]</b><br>너무 딱딱하지도, 너무 감정적이지도 않은 가장 이상적인 두뇌선입니다. 상황에 따라 냉철한 판단을 내리기도 하고, 때로는 따뜻한 공감을 보여주는 당신은 진정한 외유내강형입니다.",
                    "🎨 <b>[실용적인 창작자]</b><br>현실에 발을 딛고 있으면서도 머릿속으로는 끊임없이 새로운 것을 상상합니다. 당신의 아이디어는 뜬구름 잡는 소리가 아니라, 실제로 실현 가능한 알짜배기들입니다."
                ],
                'curved': [
                    "🎭 <b>[풍부한 상상력의 아티스트]</b><br>남들이 보지 못하는 것을 보는 눈을 가졌습니다. 논리적인 설명보다는 순간적인 영감이나 직관이 더 잘 맞을 때가 많으며, 틀에 박힌 것을 거부하는 자유로운 영혼입니다.",
                    "🌙 <b>[직관이 뛰어난 몽상가]</b><br>이성적으로 따지기보다 '느낌'이 올 때 움직이는 편이군요. 타인의 기분이나 분위기를 기가 막히게 감지하는 능력이 있어, 예술이나 사람을 상대하는 일에서 천재성을 발휘합니다.",
                    "🔮 <b>[감수성이 예민한 천재]</b><br>가끔 혼자만의 생각에 깊이 잠길 때가 있지 않나요? 당신의 내면세계는 매우 깊고 넓어서, 남들은 이해하기 힘든 독창적인 아이디어가 샘솟는 화수분과 같습니다."
                ]
            },
            'head_destination_book': {
                'mars_2': "💰 <b>[돈 냄새를 맡는 실리파]</b><br>현실 감각이 매우 뛰어납니다. 손해 보는 장사는 절대 하지 않으며, 숫자와 계산에 밝아 재테크나 비즈니스에서 탁월한 수완을 발휘합니다.",
                'moon_upper': "👑 <b>[사람을 이끄는 리더]</b><br>현실적인 문제 해결 능력과 창의적인 비전을 동시에 갖췄습니다. 상식적이면서도 책임감이 강해 조직을 이끄는 리더나 전문직으로서 존경받을 운명입니다.",
                'moon_middle': "🎉 <b>[아이디어 뱅크]</b><br>당신의 머릿속에는 남들을 즐겁게 할 아이디어가 가득하군요! 유연한 사고방식과 재치 있는 입담으로 분위기 메이커 역할을 합니다.",
                'moon_lower': "📚 <b>[영혼이 맑은 예술가]</b><br>물질적인 성공보다는 정신적인 가치와 마음의 평화를 추구합니다. 신비로운 분야나 순수 예술, 문학 등에서 독보적인 세계를 구축할 수 있습니다.",
                'mercury': "🕵️ <b>[비상한 전략가]</b><br>눈치가 100단이고 임기응변에 능합니다. 남들이 놓치는 틈새시장을 찾아내는 능력이 탁월하여, 사업 기획이나 컨설팅 분야에서 활약할 것입니다.",
                'sun': "💎 <b>[화려한 스타성]</b><br>자신을 돋보이게 하는 방법을 본능적으로 알고 있어, 연예계나 뷰티, 패션 등 화려한 분야에서 성공할 잠재력이 있습니다.",
                'saturn': "🙏 <b>[끝없는 구도자]</b><br>현실의 만족보다 더 높은 가치를 좇습니다. 종교, 철학, 심리학 등 인간의 내면을 탐구하는 일에 깊은 관심이 있으며 멘토가 될 자질이 있습니다."
            },

            # --- [감정선] ---
            'heart_start_book': {
                'standard': [
                    "⚖️ <b>[이성과 감정의 황금비율]</b><br>어떤 상황에서도 평정심을 유지할 줄 아는군요. 너무 차갑지도 뜨겁지도 않은 온도로 사람을 대하기에 실수가 없고 신뢰받습니다.",
                    "⚖️ <b>[믿음직한 파트너]</b><br>당신은 감정에 휘둘리지 않고 중심을 잡을 줄 압니다. 연애에서도 뜨거운 불꽃보다는 따뜻한 난로처럼 은은하고 오래가는 관계를 선호하는군요."
                ],
                'high': [
                    "🔥 <b>[브레이크 없는 열정]</b><br>사랑에 빠지면 물불 가리지 않는 열정파입니다! 감정 표현이 화끈하지만, 때로는 질투심이나 소유욕이 불타오르기도 합니다.",
                    "💖 <b>[감수성 풍부한 로맨티시스트]</b><br>감정선이 높게 시작하는 당신은 감수성이 매우 풍부합니다. 영화 같은 사랑을 꿈꾸며, 작은 이벤트에도 큰 감동을 받는 낭만파입니다.",
                    "✨ <b>[재지 않는 솔직함]</b><br>좋으면 좋다, 싫으면 싫다! 당신은 자신의 감정을 숨기지 않습니다. 밀당 같은 계산적인 연애보다는, 내 마음 가는 대로 직진하는 솔직함이 매력입니다.",
                    "🌳 <b>[아낌없이 주는 나무]</b><br>좋아하는 사람을 위해서라면 자신의 것을 기꺼이 내어줄 줄 아는 헌신적인 타입입니다. 상대방의 행복이 곧 나의 행복이라 믿는 따뜻한 마음을 가졌군요.",
                    "🌈 <b>[분위기 메이커의 심장]</b><br>특유의 밝고 외향적인 에너지로 주변을 환하게 밝힙니다. 풍부한 리액션과 공감 능력으로 상대방을 무장해제시키는 마력이 있습니다."
                ],
                'low': [
                    "❄️ <b>[침착한 포커페이스]</b><br>겉으로 감정을 잘 드러내지 않아 '속을 모르겠다'는 말을 듣지만, 사실 누구보다 깊고 진중한 마음을 가졌습니다. 의리파입니다.",
                    "🧊 <b>[냉철한 이성주의자]</b><br>어떤 상황에서도 흥분하지 않고 차분하게 대처합니다. 연애를 할 때도 감정보다는 현실적인 조건을 먼저 고려하는 신중함이 돋보입니다.",
                    "🛡️ <b>[상처받기 싫은 고슴도치]</b><br>마음이 약해질까 봐 일부러 차가운 척 방어벽을 치고 있진 않나요? 한 번 마음을 열기까지는 오래 걸리지만, 내 사람에게는 세상 누구보다 든든한 버팀목입니다.",
                    "💎 <b>[알짜배기 실속파]</b><br>쓸데없는 감정 소모를 싫어하며 에너지를 효율적으로 관리합니다. 겉치레보다는 본질을 꿰뚫어 보는 안목이 있어, 인간관계에서도 소수의 깊은 유대를 선호합니다.",
                    "🧘 <b>[흔들리지 않는 편안함]</b><br>감정의 기복이 적어 주변 사람들에게 안정감을 줍니다. 위기 상황에서 가장 먼저 평정심을 되찾고 해결책을 제시하는 차가운 머리와 뜨거운 의리를 동시에 지녔습니다."
                ]
            },
            'heart_shape_book': {
                'straight': [
                    "📏 <b>[돌직구 직진남녀]</b><br>밀당? 그런 건 딱 질색이시죠. 좋으면 좋다, 싫으면 싫다 확실하게 표현하는 솔직 담백한 성격입니다. 뒤끝이 없어 쿨한 매력이 돋보입니다.",
                    "🎯 <b>[심플하고 명확한 사랑]</b><br>사랑도 일도 군더더기 없는 것을 선호합니다. 복잡하게 꼬인 관계보다는 서로의 진심을 가감 없이 공유할 때 가장 큰 행복을 느끼는 타입입니다.",
                    "🧭 <b>[흔들림 없는 주관]</b><br>주변의 평판이나 분위기에 휩쓸리기보다 자신의 감정 기준이 명확합니다. 감정 과잉이 없어 공적인 자리에서도 신뢰받는 듬직한 리더의 자질이 있습니다."
                ],
                'curved': [
                    "🌊 <b>[따뜻한 감성 힐러]</b><br>타인의 감정을 내 것처럼 느끼는 공감 능력을 가졌습니다. 상대방의 기분을 먼저 살피는 따뜻한 마음씨 덕분에 주변에 사람이 끊이지 않습니다.",
                    "🎨 <b>[예술적 감수성의 소유자]</b><br>곡선형 감정선은 풍부한 상상력과 낭만을 상징합니다. 작은 꽃 한 송이, 노을 지는 풍경에도 감동할 줄 아는 부드럽고 섬세한 영혼을 가졌군요.",
                    "🧸 <b>[모성애/부성애 가득한 다정함]</b><br>연인이나 친구에게 아낌없는 애정을 쏟으며, 상대방을 챙겨주는 것에서 기쁨을 찾습니다. 당신과 함께 있으면 누구나 편안함과 안정을 느낍니다."
                ],
                'hybrid': [
                    "🎭 <b>[알다가도 모를 반전 매력]</b><br>냉정과 열정 사이를 오가는 양면성이 있습니다. 이 '종잡을 수 없는 매력'이 이성에게는 치명적인 호기심을 자극합니다. 밀당의 고수시군요!",
                    "🌓 <b>[이성과 감성의 완벽한 조화]</b><br>공감할 땐 누구보다 뜨겁게, 판단할 땐 누구보다 냉철하게! 상황에 따라 유연하게 대처하는 능력이 탁월하여 어떤 조직에서도 적응력이 뛰어납니다.",
                    "🌪️ <b>[신비로운 분위기]</b><br>속마음을 쉽게 알 수 없어 더 궁금해지는 사람입니다. 겉으론 평온해 보여도 내면엔 수만 가지 생각이 소용돌이치고 있군요. 그 신비로움이 당신만의 독보적인 아우라입니다."
                ]
            },
            'heart_end_book': {
                'cross': "🔒 <b>[집착과 소유의 끝판왕]</b><br>당신에게 사랑은 '전부 아니면 전무'입니다. 사랑하는 사람을 완전히 소유하고 싶어 하는 독점욕이 강합니다.",
                'jupiter': "🏰 <b>[신중한 로맨티시스트]</b><br>자존심이 높고 눈도 높습니다. 존경할 수 있는 대상을 찾아 천천히 사랑을 키워갑니다. 한 번 마음을 열면 변치 않는 건실한 연애를 합니다.",
                'index_border': "🌻 <b>[해바라기]</b><br>평소엔 이성적이지만 사랑 앞에서는 맹목적인 바보가 됩니다. 상대방을 너무 믿고 헌신하다가 상처받기 쉬우니 주의하세요.",
                'index_middle_down': "❤️‍🔥 <b>[가슴 속 마그마]</b><br>겉보기엔 얌전해 보이지만 가슴 속에는 뜨거운 열정이 있습니다. 짝사랑을 오래 하거나 속앓이를 하는 경우가 많습니다.",
                'index_middle_end': "💍 <b>[결혼하고 싶은 사람 1위]</b><br>축하합니다! 가장 이상적인 위치입니다. 연애를 장난으로 하지 않으며, 성실하고 가정적입니다. 최고의 배우자 감입니다.",
                'middle_border': "🍲 <b>[금방 끓고 식는 냄비]</b><br>열정이 확 타올랐다가 금방 시들해지는 '냄비 근성'이 있군요. 설렘보다 익숙함의 소중함을 깨닫는 것이 중요합니다.",
                'middle_down': "😎 <b>[쿨내 진동하는 자유인]</b><br>연애는 인생의 일부일 뿐입니다. 구속받는 것을 싫어하고 프라이버시를 중요하게 생각합니다. 쿨한 매력이 인기의 비결입니다.",
                'index_down_life': "🍎 <b>[위험한 유혹]</b><br>평범한 연애보다 장애물이 있는 '금단의 사랑'에 끌리는 경향이 있습니다. 스릴을 즐기지만 그 끝은 상처일 수 있습니다.",
                'middle_down_life': "👑 <b>[내 멋대로 하는 사랑]</b><br>자기중심적인 성향이 강해 내 뜻대로 상대가 움직여주길 바랍니다. 고집을 부리면 결국 곁에 아무도 남지 않게 됩니다."
            },

            # --- [운명선: 랜덤 텍스트 리스트] ---
            'fate_path': {
                 'support': [
                    "🤝 <b>[최고의 참모: 2인자의 미학] (옅은 운명선)</b><br>당신의 운명선은 은은하게 흐르는 시냇물 같습니다. 이는 리더를 전면에서 이끌기보다, 보이지 않는 곳에서 판을 짜고 조직을 완성하는 '킹메이커'의 기질을 뜻합니다.",
                    "🛡️ <b>[유연한 처세가: 보이지 않는 손] (옅은 운명선)</b><br>강한 자가 살아남는 것이 아니라 살아남는 자가 강한 것임을 당신은 본능적으로 알고 있습니다. 운명선이 옅다는 것은 정해진 틀이 없다는 뜻입니다.",
                    "🌊 <b>[물류의 지배자: 형태 없는 강함] (옅은 운명선)</b><br>당신의 운명은 고정된 바위가 아니라 흐르는 물과 같습니다. 뚜렷한 선이 없다는 것은 어디로든 흐를 수 있고, 어떤 그릇에도 담길 수 있다는 뜻입니다."
                 ]
            },
            'fate_start_book': {
                'venus': [
                    "👪 <b>[가문의 영광: 금수저의 기운]</b><br>부모, 형제 등 가족의 전폭적인 지원을 받아 운이 열립니다. 당신의 뿌리는 매우 튼튼하여, 넘어지더라도 언제든 돌아갈 곳이 있다는 심리적 안정감이 가장 큰 자산입니다.",
                    "👪 <b>[든든한 울타리: 상속받은 행운]</b><br>당신은 맨땅에 헤딩하기보다는 이미 잘 닦인 길 위에서 출발할 운명입니다. 가족이나 가까운 친척의 유산, 혹은 가업을 이어받아 풍요로운 삶을 누릴 가능성이 높습니다.",
                    "🛡️ <b>[뿌리 깊은 나무]</b><br>어린 시절부터 형성된 가족과의 유대감이 당신의 사회적 성공에 결정적인 역할을 합니다. 보이지 않는 곳에서 당신을 밀어주는 조력자가 늘 존재하며, 가문의 명예를 높일 기회가 찾아올 것입니다."
                ],
                'mars_1': [
                    "🦁 <b>[난세의 영웅: 야망가의 기질]</b><br>평화로운 시대보다 사회가 혼란스럽거나 불황일 때 오히려 더 큰 힘을 발휘하는 타입입니다. 야망이 크고 시대의 흐름을 읽는 동물적인 감각이 있어, 결국에는 난관을 뚫고 정상에 깃발을 꽂을 운명입니다.",
                    "🦁 <b>[불굴의 투사: 역경을 먹고 자라는 나무]</b><br>당신에게 편안함은 독입니다. 오히려 경쟁이 치열하고 장애물이 많을수록 당신의 투쟁심은 불타오릅니다. 남에게 지기 싫어하는 승부욕과 강한 추진력으로, 척박한 환경에서도 기어코 꽃을 피워내는 자수성가의 아이콘입니다.",
                    "🌋 <b>[멈출 수 없는 용암]</b><br>한번 목표를 정하면 앞뒤 재지 않고 돌진하는 저력이 있습니다. 주변에서는 무모하다고 말할지 모르지만, 당신은 이미 본능적으로 승리를 확신하고 있군요. 위기 속에서 판을 뒤집는 승부사 기질이 강합니다."
                ],
                'venus_moon_middle': [
                    "🛠️ <b>[성실함의 승리: 자수성가의 표본]</b><br>요행을 바라지 않고 오직 자신의 땀과 노력으로 운을 개척하는 정직한 사람입니다. 자신이 흘린 땀방울만큼 정직한 보상을 받을 때 가장 큰 행복을 느낍니다.",
                    "🛠️ <b>[믿음직한 개척자: 스스로 만드는 길]</b><br>누군가에게 의지하기보다는 내 손으로 직접 성취하는 것을 즐깁니다. 재주가 많고 손재주가 뛰어나 무엇이든 시작하면 평균 이상은 해내는군요. 초년의 경험들이 훗날 당신을 지탱하는 단단한 뿌리가 될 것입니다.",
                    "🏗️ <b>[완벽한 설계자]</b><br>당신의 인생은 요행이 아닌 철저한 계획과 성실함으로 쌓아 올린 금자탑입니다. 남들이 쉽게 가는 길을 부러워하지 마세요. 당신이 천천히 쌓은 성은 절대 무너지지 않는 견고한 요새가 될 것입니다."
                ],
                'mars_2': [
                    "🤝 <b>[파트너 복이 터졌다: 인복의 제왕]</b><br>당신의 성공 열쇠는 '사람'에게 있습니다. 특히 배우자나 비즈니스 파트너를 잘 만나면 인생이 송두리째 바뀔 수 있습니다. 혼자 애쓰기보다는 능력 있는 사람과 손잡고 시너지를 낼 때 상상 이상의 결과를 얻게 될 것입니다.",
                    "🤝 <b>[귀인의 도움: 협력의 미학]</b><br>어려운 순간마다 기적처럼 도와주는 귀인이 나타나는 운세입니다. 당신은 타인의 마음을 얻고 협력을 이끌어내는 탁월한 사교성을 지녔습니다. 겸손한 태도로 주변을 챙긴다면, 당신의 성공은 모두의 축복이 될 것입니다.",
                    "🌌 <b>[사람을 끌어당기는 자력]</b><br>당신은 본인도 모르게 타인에게 신뢰를 주는 묘한 매력이 있습니다. 인맥이 곧 재산인 운명으로, 적을 만들지 않는 당신의 유연함이 결정적인 순간에 천금 같은 기회를 가져다줄 것입니다."
                ],
                'moon': [
                    "🌟 <b>[대중의 아이돌: 타고난 스타성]</b><br>당신은 가만히 있어도 사람들의 시선을 끄는 묘한 매력이 있습니다. 고향을 떠나 타지나 해외에서 더 크게 성공할 운명이며, 대중의 사랑과 인기를 먹고 자라는 나무입니다.",
                    "🌟 <b>[매력 자본가: 사람을 홀리는 힘]</b><br>논리보다는 감성으로, 실력보다는 매력으로 승부할 때 더 큰 성과를 냅니다. 당신의 팬이나 지지자들이 든든한 배경이 되어줄 것입니다. 당신의 끼를 마음껏 발산할 수 있는 자유로운 무대가 필요합니다.",
                    "🕊️ <b>[경계를 넘는 여행자]</b><br>익숙한 곳보다는 낯선 곳에서 운이 트입니다. 외국계 기업, 무역, 혹은 온라인을 통해 전 세계 사람들과 소통하는 일에서 두각을 나타낼 것입니다. 당신의 무대는 생각보다 훨씬 넓습니다."
                ],
                'mars_plain': [
                    "🔥 <b>[진흙 속의 연꽃: 불굴의 의지]</b><br>손바닥 중앙에서 시작하는 선은 초년의 방황을 의미합니다. 하지만 좌절하지 마세요. 그 시련은 당신을 강철처럼 단련시키기 위한 과정입니다. 중년 이후 당신의 잠재력은 폭발할 것이며, 고생 끝에 낙이 온다는 말을 몸소 증명할 것입니다.",
                    "🔥 <b>[인내의 화신: 늦게 피는 꽃]</b><br>남들보다 출발은 늦었을지 몰라도, 당신의 뒷심은 무섭습니다. 숱한 실패와 좌절 속에서도 오뚝이처럼 다시 일어나는 강인한 생명력을 지녔군요. 당신의 인생 하이라이트는 아직 오지 않았습니다.",
                    "💎 <b>[세공 중인 원석]</b><br>지금 당장 성과가 보이지 않는다고 조급해하지 마세요. 당신은 현재 가장 빛나는 보석이 되기 위해 깎이고 다듬어지는 과정에 있습니다. 머지않아 세상이 당신의 가치를 알아보고 경탄할 날이 올 것입니다."
                ],
                'above_life': [
                    "🐢 <b>[노력은 배신하지 않는다: 끈기의 승부사]</b><br>생명선 위에서 시작하는 운명선은 피나는 노력의 결실을 상징합니다. 젊은 시절에는 기회를 잡기 어려워 답답할 수 있지만, 당신은 결코 포기하지 않습니다. 결국엔 해당 분야의 일인자가 됩니다.",
                    "🐢 <b>[성실함의 결정체: 티끌 모아 태산]</b><br>요령 피우지 않고 우직하게 자신의 길을 가는 거북이 같은 사람입니다. 당장은 토끼보다 느려 보일지 몰라도, 최후의 승자는 결국 당신이 될 것입니다. 당신의 땀방울은 거대한 부와 명예로 돌아옵니다.",
                    "🧱 <b>[한 우물을 파는 장인]</b><br>이것저것 손대기보다 한 분야에 집중할 때 운이 폭발합니다. 당신이 지금 묵묵히 하고 있는 그 일이 훗날 당신을 범접할 수 없는 위치로 올려줄 것입니다. 끝까지 버티는 자가 승리하는 법입니다."
                ],
                'above_head': [
                    "💡 <b>[천재적 두뇌: 재능으로 성공]</b><br>두뇌선 위에서 시작하는 운명선은 타고난 재능과 아이디어로 승부함을 뜻합니다. 30대 중반 이후, 당신의 지적 능력이 만개하며 사회적으로 두각을 나타내기 시작할 것입니다.",
                    "💡 <b>[늦깎이 천재: 머리로 돈을 버는 사람]</b><br>몸으로 때우는 일보다는 머리를 쓰는 일에서 성공합니다. 초년에는 재능을 다듬는 시간이 필요하지만, 한 번 빛을 보기 시작하면 무서운 속도로 성장합니다. 지적 자산이 중요한 분야에서 대성할 운입니다.",
                    "🧠 <b>[지략의 승부사]</b><br>당신의 운명은 당신의 기발한 발상에 달려 있습니다. 남들이 보지 못하는 틈새를 읽어내는 안목이 탁월하군요. 복잡한 문제를 단숨에 해결하는 당신의 지혜가 곧 당신의 가장 큰 재산입니다."
                ],
                'above_heart': [
                    "🏆 <b>[인생은 50부터: 화려한 인생 역전]</b><br>감정선 위에서 늦게 시작하는 운명선은 전형적인 대기만성형입니다. 50대 이후, 은퇴를 걱정할 나이에 오히려 제2의 전성기를 맞이합니다. 존경받는 리더나 멘토로서 사회에 공헌하게 될 것입니다.",
                    "🏆 <b>[노익장 과시: 끝이 좋은 사람]</b><br>당신의 인생은 초반보다 후반으로 갈수록 화려해집니다. 은퇴 후에 시작한 사업이나 취미가 대박이 날 수도 있겠군요. 당신의 말년은 그 어떤 부자도 부럽지 않을 만큼 풍요롭고 평안할 것입니다.",
                    "🌅 <b>[가장 화려한 노을]</b><br>젊은 날의 고생이 말년의 복으로 돌아옵니다. 자식 복과 재물 복이 말년에 집중되어 있으니 현재의 어려움에 낙담하지 마세요. 당신의 진짜 이야기는 이제부터 시작입니다."
                ],
                'wrist_straight': [
                    "🚀 <b>[직진 본능: 마이웨이 외골수]</b><br>손목에서부터 중지까지 일직선으로 뻗은 운명선은 타협을 모르는 강직함을 의미합니다. 주변의 시선이나 방해에도 아랑곳하지 않고, 자신이 믿는 길을 향해 전차처럼 돌진합니다.",
                    "🚀 <b>[천상천하 유아독존: 독보적 존재감]</b><br>남의 밑에 있기를 거부하고 오직 자신의 왕국을 건설하려는 제왕의 기질이 있습니다. 타협을 모르는 성격 탓에 적도 많겠지만, 그만큼 당신을 따르는 충성스러운 지지자도 많을 것입니다.",
                    "⚡ <b>[운명의 지배자]</b><br>하늘이 내린 길을 걷는 사람입니다. 거침없는 추진력과 결단력으로 주변 환경을 자신에게 유리하게 변화시키는 능력이 있습니다. 당신이 가는 곳이 곧 역사가 됩니다."
                ]
            },
            'fate_end_book': {
                'saturn': [
                    "🏅 <b>[고독한 승부사: 명예로운 성공]</b><br>재물보다는 명예와 성취감을 더 중요하게 생각하는군요. 스스로 정한 목표를 달성했을 때 가장 큰 희열을 느끼며, 당신이 쌓아 올린 업적은 길이길이 남을 것입니다.",
                    "🏅 <b>[자수성가의 끝판왕: 홀로 선 소나무]</b><br>누구의 도움도 없이 오직 자신의 힘으로 정상에 오르는 운명입니다. 독립적인 삶을 추구하며 고독을 즐길 줄 아는 당신, 그 고고함이 당신을 더욱 빛나게 만듭니다.",
                    "🏔️ <b>[정상의 고독]</b><br>남들은 당신을 부러워하지만 정작 당신은 늘 외로운 싸움을 하고 있군요. 하지만 그 고독함이 당신을 더욱 단단하게 만듭니다. 사회적 지위와 명성을 모두 거머쥘 운명입니다."
                ],
                'jupiter': [
                    "🤝 <b>[야망의 정치가: 권력과 지위]</b><br>권력욕과 명예욕이 남다르군요. 단순히 돈을 버는 것을 넘어, 사람들을 지휘하고 영향력을 행사하는 자리에 올라야 직성이 풀립니다. 리더십이 필요한 분야에서 두각을 나타낼 것입니다.",
                    "🤝 <b>[신뢰의 아이콘: 존경받는 리더]</b><br>돈보다는 사람을 남기는 장사를 합니다. 인복이 좋아 주변에 따르는 사람이 많고, 사회적인 신용을 바탕으로 성공의 계단을 오릅니다. 당신의 성공은 모두의 승리입니다.",
                    "🏛️ <b>[조직의 심장]</b><br>어디를 가든 자연스럽게 리더의 자리에 서게 됩니다. 당신의 말 한마디가 조직을 움직이는 무게감을 지니게 될 것이며, 많은 이들이 당신의 판단을 따르게 될 것입니다."
                ],
                'sun': [
                    "💰 <b>[화려한 재력가: 연예인급 인기]</b><br>남들에게 주목받고 박수받는 것을 즐기며, 그런 관심이 곧 돈으로 연결됩니다. 뛰어난 화술로 큰 부를 축적하며, 화려하고 럭셔리한 삶을 살게 될 것입니다.",
                    "💰 <b>[행운의 총아: 즐기면서 돈 벌기]</b><br>자신이 좋아하는 일을 즐기면서 돈까지 버는 행운아입니다. 금전 감각이 탁월하여 돈을 불리는 재주가 있고, 인생을 축제처럼 즐기는 당신, 정말 부럽습니다!",
                    "💎 <b>[부와 명예의 결실]</b><br>당신이 지나온 길에는 황금이 깔려 있습니다. 재물운이 끊이지 않아 평생 풍족함을 누릴 것이며, 당신의 이름은 곧 성공의 대명사가 될 것입니다."
                ],
                'head_stop': [
                    "🛑 <b>[돌다리 두드리기: 신중한 현실주의자]</b><br>30대 중반쯤 한 번의 큰 결단이 필요함을 암시합니다. 자신의 재능을 믿고 과감하게 승부수를 띄워야 할 때입니다. 너무 계산만 하다가 기회를 놓치지 않도록 주의하세요.",
                    "🛑 <b>[지략가의 딜레마: 머리로 사는 인생]</b><br>판단 착오 한 번으로 공든 탑이 무너질 수도, 아이디어 하나로 인생 역전할 수도 있습니다. 감정보다는 이성에 귀를 기울이세요. 당신의 머리가 곧 자산입니다.",
                    "🧩 <b>[인생의 변환점]</b><br>현재의 성과에 안주하지 말고 지적인 도전을 계속해야 합니다. 당신의 영리함이 때로는 독이 될 수 있으니, 한 번 더 생각하고 움직이는 신중함이 큰 화를 면하게 해줄 것입니다."
                ],
                'heart_stop': [
                    "❤️ <b>[열정의 배신: 사랑과 성공 사이]</b><br>50대 초반, 감정적인 문제나 인간관계로 인해 제동이 걸릴 수 있습니다. 성공도 좋지만, 곁에 있는 사람을 챙기는 것이 롱런의 비결임을 잊지 마세요.",
                    "❤️ <b>[은퇴 후의 여유: 안분지족]</b><br>사회적 성공보다는 내면의 평화와 행복을 중요시하게 됩니다. 50대 이후에는 욕심을 내려놓고 취미 생활이나 봉사 활동을 하며 제2의 인생을 즐기게 될 것입니다.",
                    "🧘 <b>[마음의 안식처]</b><br>치열한 경쟁 사회에서 벗어나 자신만의 평화로운 삶을 구축하게 됩니다. 물질적인 풍요보다 사랑하는 사람들과 함께하는 시간이 당신에게 가장 큰 가치가 될 것입니다."
                ]
            },

            # [NEW] 운명선 랜덤 조언 (다양성 확보용)
            'fate_advice': [
                "🔮 <b>[AI 도사의 조언]</b> 올해는 새로운 문서를 잡을 운이 강합니다. 계약이나 투자에 있어 과감한 결단이 필요할 수 있습니다.",
                "🔮 <b>[AI 도사의 조언]</b> 주변에 당신을 질투하는 사람이 보입니다. 하지만 그 질투조차 당신의 성공을 증명하는 훈장이니 개의치 마세요.",
                "🔮 <b>[AI 도사의 조언]</b> 이동수가 보입니다. 이직, 이사, 혹은 긴 여행을 통해 새로운 기운을 얻게 될 것입니다. 고인 물은 썩는 법입니다.",
                "🔮 <b>[AI 도사의 조언]</b> 귀인은 멀리 있지 않습니다. 평소 소홀히 대했던 옛 친구나 동료가 뜻밖의 행운을 가져다줄 수 있습니다.",
                "🔮 <b>[AI 도사의 조언]</b> 두 가지 일을 동시에 하는 '투잡'의 기운이 있습니다. 본업 외의 취미가 쏠쏠한 부수입이 될 수 있으니 개발해 보세요."
            ],

            'special_signs': {
                'm_sign': "🏆 <b>[전설의 대박 징조, M자 손금!]</b><br>행운을 거머쥐는 최고의 길상입니다!",
                'rich_triangle': "💰 <b>[재물 삼각 창고]</b><br>평생 돈 걱정 없는 알부자 손금입니다.",
                'no_fate': "🦅 <b>[길 없는 곳이 내 길]</b><br>자유로운 영혼입니다."
            },

            'spicy_title': "🔞 <b>[Forbidden] 관능의 심연: 당신이 숨긴 짐승의 얼굴</b>",

            'libido': {
                'level_5': ("🔥 <b>[폭주하는 정복자: 발정의 화신]</b><br>"
                            "금성구가 터질 듯 부풀어 오른 당신은 이성의 끈이 풀리는 순간, 굶주린 포식자로 돌변합니다. "
                            "단순한 교감을 넘어 상대를 완전히 제압하고 탈진시켜 침대 위에서 손가락 하나 까딱하지 못하게 만들어야 직성이 풀리는군요. "
                            "지치지 않는 체력과 파괴적인 스테미너는 파트너를 황홀경을 넘어선 공포와 쾌락의 경계로 몰아넣으며, "
                            "당신의 밤은 문명의 규율이 통하지 않는 원초적이고 난폭한 유린의 현장이 됩니다."),

                'level_3': ("🍷 <b>[농밀한 쾌락 탐닉자: 가학적 테크니션]</b><br>"
                            "당신은 상대의 가장 예민하고 수치스러운 곳을 집요하게 공략해 정신을 무너뜨리는 데 천부적인 재능이 있습니다. "
                            "정확한 완급 조절과 질척이는 터치로 상대의 자제력을 짓밟으며, "
                            "수치심마저 잊고 당신의 손길에 중독되어 짐승처럼 애원하게 만드는 밤의 지배자입니다. "
                            "상대를 완전히 압도하는 당신의 기운은 그들을 황홀한 복종의 길로 인도합니다. 당신의 손길 아래서 거칠게 터져 나오는 상대의 반응을 탐닉하며,"
                            " 그들의 온몸 구석구석에 당신이라는 존재를 지울 수 없는 낙인으로 새겨버리는 밤의 제왕입니다."),

                'level_1': ("🍃 <b>[은밀한 관조자: 가디즘의 정석]</b><br>"
                            "겉으로는 고결하고 평온해 보이지만, 당신의 내면에는 상대를 정신적으로 완전히 굴복시키려는 뒤틀린 욕망이 가득합니다. "
                            "단순한 삽입보다 상대가 당신의 명령 한마디에 자존심을 버리고 수치스럽게 무너지는 모습에서 형언할 수 없는 희열을 느끼는군요. "
                            "당신은 상대의 심리를 잠식하여 당신 없이는 쾌락을 느낄 수 없는 '중독 상태'로 만드는 것을 즐기는 위험한 은둔자입니다.")
            },

            'seduction': {
                'bad_charmer': ("😈 <b>[치명적인 조련사: 영혼의 포식자]</b><br>"
                        "상대의 자존감을 서서히 갉아먹으며 당신의 그늘 아래 복종하게 만드는 고수입니다. "
                        "계산된 차가움과 뜨거움을 오가며 상대를 정신적으로 해체하고, "
                        "결국 당신의 발밑에 엎드려 굴복하는 순간 비로소 완전한 절정에 도달합니다. "
                        "사랑이라는 이름으로 포장된 당신의 조련은 상대에게 가장 달콤하면서도 치명적인 독약이 됩니다."),

                'hot_lover': ("❤️‍🔥 <b>[브레이크 고장 난 불도저: 본능의 노예]</b><br>"
                              "도덕, 상식, 사회적 체면? 당신에게는 그저 거추장스러운 껍데기일 뿐입니다. "
                              "욕망의 스위치가 켜지는 순간 장소를 가리지 않고 본능을 폭발시키며, "
                              "짐승 같은 날것의 몸짓과 거친 숨소리로 온 공간을 당신의 체취와 타액으로 물들입니다. "
                              "상대를 배려하기보다 당신의 폭발하는 발정기를 해소하기 위해 닥치는 대로 탐닉하는 정열의 괴물입니다."),

                'shy_fox': ("🦊 <b>[낮져밤이의 정석: 가면 쓴 변태성]</b><br>"
                            "낮에는 정숙하고 순진한 가면을 쓰고 있지만, 밀실의 문이 잠기는 순간 그 누구보다 저열하고 음탕한 본색을 드러냅니다. "
                            "그 정갈한 입술에서 쏟아지는 믿기 힘든 수준의 저속한 요구와 대담한 도발은 상대를 경악하게 만들지만, "
                            "그 파격적인 반전이 주는 쾌락에 파트너는 영원히 당신의 노예가 되어버리고 맙니다."),

                'cool_friend': ("😎 <b>[감정 거세된 쾌락 기계: 섹스 파트너의 표본]</b><br>"
                                "질척거리는 감정은 쓰레기통에 버리고 오직 말초적인 신경의 떨림에만 집중합니다. "
                                "상대를 인격체가 아닌 정교하게 설계된 '쾌락의 도구'로 대하며, "
                                "가장 농밀한 행위 직후에도 아무런 미련 없이 차갑게 돌아서는 당신의 냉혈함은 역설적으로 상대의 정복욕을 미친 듯이 자극합니다."),

                'devoted_puppy': ("🐶 <b>[자발적 노예: 피지배적 탐닉]</b><br>"
                                  "상대의 가장 저급하고 가학적인 명령에도 기꺼이 순응하며 자존심마저 뭉개지는 것을 즐기는 타입입니다. "
                                  "수치심이 극에 달할수록 당신의 신경 세포는 비정상적으로 타오르며, "
                                  "철저히 파괴당하고 굴복당할 때 비로소 진정한 해방감과 함께 극상의 오르가즘을 만끽하는 지독한 마조히스트 기질이 다분합니다.")
            },

            'fantasy': {
    'deep': [
        ("🦄 <b>[금기를 부수는 가학적 설계자]</b><br>"
         "당신의 뇌리는 이미 도덕적 상식을 아득히 넘어선 하드코어한 시나리오로 가득 찬 금서 목록입니다. "
         "단순한 행위는 당신에게 수치심조차 주지 못하는 지루한 유희일 뿐이군요. "
         "상대의 손목을 묶고, 안대를 씌우고, 당신의 명령에만 반응하도록 조련하며 그들이 수치심에 몸부림칠 때 비로소 타오르는 변태적인 희열을 즐깁니다. "
         "남들이 타락이라 부르는 그 심연 속에서 당신은 가장 잔혹하고도 황홀한 쾌락의 왕으로 군림할 운명입니다."),

        ("⛓️ <b>[그림자 속의 가디스트: 영혼의 해체자]</b><br>"
         "당신은 상대의 육체뿐만 아니라, 그들의 자존감까지 남김없이 뭉개버리고 싶어 하는 은밀한 파괴자입니다. "
         "정교하게 짜인 가학적 시나리오 속에서 상대가 당신 없이는 단 한 순간의 쾌락도 느끼지 못하게 만드는 '정신적 중독'을 즐기는군요. "
         "금지된 도구와 억압적인 행위가 일상이 된 당신의 침실은, 문명의 법도 대신 오직 당신의 저속한 욕망만이 유일한 법이 되는 관능의 감옥이 됩니다.")
    ],

    'real': [
        ("💼 <b>[노골적인 육체 포식자: 교미의 화신]</b><br>"
         "은유적인 대화나 분위기 잡기는 당신에게 그저 가식적인 시간 낭비일 뿐입니다. "
         "당신은 오직 끈적이는 타액, 거친 마찰음, 그리고 이성이 마비된 채 짐승처럼 엉겨 붙는 육체의 충돌 그 자체에 환장합니다. "
         "상대의 가식적인 옷가지를 찢어발기고 가장 추하고 본질적인 밑바닥을 파헤쳐야 직성이 풀리는 타입이군요. "
         "사랑이라는 포장을 벗겨내고 오직 원초적인 성욕과 교미의 본능만을 폭발시키는 밤의 포식자입니다."),

        ("🔥 <b>[발정의 수혈자: 하드코어 짐승]</b><br>"
         "당신에게 밤은 사랑을 나누는 시간이 아니라, 서로의 육체를 닥치는 대로 유린하고 소진시키는 야생의 사냥터입니다. "
         "상대의 눈동자가 풀리고 거품 섞인 신음이 터져 나올 때까지 몰아붙이며, 온 공간을 당신의 체취와 비릿한 체액으로 물들여야 만족합니다. "
         "복잡한 판타지는 사치일 뿐, 당신은 오직 한계를 돌파하는 물리적인 자극과 땀범벅이 된 채 뒤섞이는 그 원초적인 교감에 미쳐있는 괴물입니다.")
    ]
},

            'outro': [
    "당신의 피 속에 소용돌이치는 이 음란하고도 추잡한 짐승의 갈증이 느껴지십니까? 이제 가식의 가면을 찢어발기고, 당신의 본능이 명령하는 대로 상대를 유린하고 탐닉하십시오.",
    "이 손금은 당신이 얼마나 저열하고도 위대한 욕망을 품고 있는지 증명하는 음란한 성전입니다. 오늘 밤, 당신의 파트너는 당신이라는 재앙 아래서 무참히 부서지고 타락할 것입니다.",
    "당신의 손바닥에 새겨진 지도는 오늘 밤 밀실에서 펼쳐질 난폭한 정사의 설계도입니다. 이성이 아닌, 꼿꼿하게 세워진 당신의 하반신 본능만을 믿고 그 젖어있는 심연으로 뛰어드십시오.",
    "금기는 유린당하기 위해 존재하는 법. 당신의 손길이 닿는 곳마다 터져 나올 비릿한 체액과 황홀한 비명을 축복합니다. 마음껏 탐닉하고, 마음껏 파괴하며 정점에 도달하십시오.",
    "이것은 예언이 아니라 당신의 혈관 속에 박동하는 저속한 진실입니다. 오늘 밤, 당신의 본색을 목격한 상대는 당신의 발바닥을 핥으며 평생을 구걸하는 육체적 노예가 될 것입니다.",
    "이미 당신의 몸은 이 정직한 손금의 결과에 미친 듯이 반응하고 있지 않나요? 억눌린 발정을 터뜨리는 순간, 당신은 지금까지 알지 못했던 극상의 타락과 나락을 경험하게 될 것입니다.",
    "상대의 절규가 당신의 이름을 연호하며 자비를 구걸할 때, 비로소 당신은 완전한 지배자가 됩니다. 타고난 정복욕이 이끄는 대로, 그들의 구멍 구석구석에 당신만의 지울 수 없는 낙인을 새기십시오.",
    "당신의 손안에는 타인의 자제력을 단숨에 박살 낼 치명적인 음독이 담겨 있습니다. 오늘 밤, 그 독을 가장 잔인하고 달콤하게 상대의 몸속 깊숙한 곳까지 주입해 보십시오.",
    "망설임은 사치일 뿐입니다. 당신의 손금이 가리키는 곳은 오직 하나, 끝없는 탐닉과 굴복이 교차하는 침대 위입니다. 자, 이제 당신 안의 짐승을 해방해 상대를 사냥할 시간입니다.",
    "이 해석이 당신의 억눌린 음란함을 깨우는 치명적인 도화선이 되길 바랍니다. 이제 당신이 꿈꾸던 그 저질스럽고 아름다운 밤의 주인이 되어, 상대의 영혼까지 남김없이 핥아 드십시오."
]
        }

    # --- 분석 로직 메서드 ---
    def get_step(self, value, thresholds):
        for i, th in enumerate(thresholds):
            if value < th: return i
        return len(thresholds)

    def analyze_life_length(self, f, h, wy):
        pts = f['points']; end_y = max(pts, key=lambda p: p[1])[1]
        ql = wy - (h * 0.25)
        if end_y > ql + (h * 0.1): return 'long'
        elif end_y > ql: return 'middle'
        else: return 'short'

    def analyze_life_curve(self, f, m):
        pts = f['points']
        if pts[0][0] < pts[-1][0]:
             ax = max(pts, key=lambda p: p[0])[0]
             if ax > m['토성'][0]: return 'big'
             elif ax > m['목성'][0]: return 'moderate'
             else: return 'small'
        return 'moderate'

    def analyze_life_dir(self, f, m):
        pts = f['points'];
        if len(pts) < 5: return 'wrist'
        dx = pts[-1][0] - pts[-5][0]
        if dx < -5: return 'thumb'
        elif dx > 5: return 'pinky'
        else: return 'wrist'

    def analyze_head_len(self, f, m):
        rx = m['태양'][0]; pts = f['points']
        ex = pts[-1][0] if pts[0][0] < pts[-1][0] else pts[0][0]
        return 'long' if ex > rx else 'short'

    # [수정] 두뇌선 모양 분석 로직 개선 (기준 세분화)
    def analyze_head_shape(self, f):
        # AI모델의 특성상 curv값이 낮게 나오는 경향이 있어 기준값을 낮춤
        # straight < 1.03 < gentle < 1.08 < curved
        if f['curv'] < 1.03: return 'straight'
        elif f['curv'] < 1.08: return 'gentle'
        else: return 'curved'

    def analyze_head_dest(self, f, m, h):
        pts = f['points']
        ep = pts[-1] if pts[0][0] < pts[-1][0] else pts[0]
        sp = pts[0] if pts[0][0] < pts[-1][0] else pts[-1]
        if ep[1] < sp[1] - (h * 0.1):
            if ep[0] > m['수성'][0]: return 'mercury'
            elif ep[0] > m['태양'][0]: return 'sun'
            else: return 'saturn'
        else:
            m2y = m['제2화성'][1]; wy = m['地'][1]
            if ep[1] < m2y + (h * 0.1): return 'mars_2'
            mt = m2y + (h * 0.1); mr = wy - mt
            if ep[1] < mt + (mr * 0.33): return 'moon_upper'
            elif ep[1] < mt + (mr * 0.66): return 'moon_middle'
            else: return 'moon_lower'

    def analyze_heart_start_book(self, f, h, py):
        pts = f['points']
        sp = pts[0] if pts[0][0] > pts[-1][0] else pts[-1]
        sy = sp[1]
        ph = h * 0.6
        ql = py + (ph * 0.25)
        if sy < ql - (ph * 0.08): return 'high'
        elif sy > ql + (ph * 0.05): return 'low'
        else: return 'standard'

    def analyze_heart_shape_book(self, f):
        curv = f['curv']
        if curv < 1.04: return 'straight'
        elif curv > 1.10: return 'curved'
        else: return 'hybrid'

    def analyze_heart_end_book(self, f, m):
        pts = f['points']
        ep = pts[0] if pts[0][0] < pts[-1][0] else pts[-1]
        jx = m['목성'][0]; sx = m['토성'][0]; lsy = m['火'][1]
        if ep[0] < jx - 30: return 'cross'
        if ep[1] > lsy:
            if abs(ep[0] - jx) < abs(ep[0] - sx): return 'index_down_life'
            else: return 'middle_down_life'
        else:
            if abs(ep[0] - jx) < 20: return 'jupiter'
            elif abs(ep[0] - sx) < 20: return 'middle_down'
            if jx < ep[0] < sx:
                if ep[1] < m['목성'][1] + 20: return 'index_middle_end'
                else: return 'index_middle_down'
            if ep[0] > sx: return 'middle_border'
            if ep[0] <= jx + 20: return 'index_border'
        return 'jupiter'

    def analyze_fate_start_book(self, f, m, features):
        pts = f['points']
        sp = pts[0] if pts[0][1] > pts[-1][1] else pts[-1]
        sx = sp[0]; sy = sp[1]

        if sy > m['地'][1] * 0.95: return 'wrist_straight'

        if 'head' in features and sy < features['head']['points'][0][1]: return 'above_head'
        if 'heart' in features and sy < features['heart']['points'][0][1]: return 'above_heart'

        center_x = m['火'][0]
        width = abs(m['목성'][0] - m['수성'][0])

        if sx < center_x - (width * 0.2): return 'venus'
        elif sx > center_x + (width * 0.2): return 'moon'
        elif sx < center_x - (width * 0.1): return 'mars_1'
        elif sx > center_x + (width * 0.1): return 'mars_2'

        if sy > m['地'][1] * 0.8: return 'venus_moon_middle'
        else: return 'mars_plain'

    def analyze_fate_end_book(self, f, m, features):
        pts = f['points']
        ep = pts[0] if pts[0][1] < pts[-1][1] else pts[-1]

        if 'head' in features:
            h_y = features['head']['points'][len(features['head']['points'])//2][1]
            if abs(ep[1] - h_y) < 30: return 'head_stop'

        if 'heart' in features:
            ht_y = features['heart']['points'][len(features['heart']['points'])//2][1]
            if abs(ep[1] - ht_y) < 30: return 'heart_stop'

        ex = ep[0]
        if ex < m['목성'][0] + 20: return 'jupiter'
        elif ex > m['태양'][0] - 20: return 'sun'
        else: return 'saturn'

    def interpret(self, features, mounts, hand_metrics):
        html_content = """
        <style>
            .palm-wrapper { background: #f0f2f5; padding: 30px 20px; border-radius: 30px; }
            .palm-container { display: flex; overflow-x: auto; gap: 25px; padding: 10px 10px 30px 10px; scroll-behavior: smooth; }
            .palm-container::-webkit-scrollbar { height: 10px; }
            .palm-container::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 10px; }
            .palm-card { flex: 0 0 360px; background: #ffffff; border-radius: 25px; padding: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); border-top: 12px solid; }
            .palm-title { font-size: 1.4em; font-weight: 900; margin-bottom: 20px; color: #1a202c; }
            .palm-desc { font-size: 1.05em; line-height: 1.8; color: #2d3748; }
            .header-bar { background: #ffffff; padding: 15px 25px; border-radius: 20px; margin-bottom: 25px; display: inline-block; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-left: 8px solid #e74c3c; }
            .header-title { font-family: 'Malgun Gothic', sans-serif; color: #1a202c; margin: 0; font-weight: 900; }
        </style>
        <div class="palm-wrapper" style="font-family: 'Malgun Gothic', sans-serif;">
            <div class="header-bar"><h2 class="header-title">🏮 내가 너 그럴 줄 알았다</h2></div>
            <div class="palm-container">
        """

        # 1. 생명선
        if 'life' in features:
            f = features['life']
            msg = []
            gap = features.get('head_life_gap', 0)
            step = self.get_step(gap, self.TH['gap'])
            keys = ['glue', 'tight', 'normal_tight', 'normal', 'normal_loose', 'loose', 'free', 'free']
            txt_start = self.texts['life_start'][keys[step]]
            msg.append(random.choice(txt_start) if isinstance(txt_start, list) else txt_start)

            len_res = self.analyze_life_length(f, hand_metrics['height'], mounts['地'][1])
            msg.append("<br>" + self.texts['life_length_book'][len_res])
            curv_res = self.analyze_life_curve(f, mounts)
            msg.append("<br>" + self.texts['life_curve_book'][curv_res])
            dir_res = self.analyze_life_dir(f, mounts)
            msg.append("<br>" + self.texts['life_direction_book'][dir_res])
            html_content += self._make_slide_card("🌿 생명선 (운명과 건강)", "#78ffe6", "".join(msg))

        # 2. 두뇌선 (수정됨: 랜덤성 + 바넘 효과 적용)
        if 'head' in features:
            f = features['head']
            msg = []
            h_len = self.analyze_head_len(f, mounts)
            msg.append(self.texts['head_length_book'][h_len])

            # [수정] 모양 분석 및 랜덤 텍스트 선택
            h_shape = self.analyze_head_shape(f)
            shape_txt_list = self.texts['head_shape_book'][h_shape]
            msg.append("<br>" + random.choice(shape_txt_list)) # 랜덤 선택

            h_dest = self.analyze_head_dest(f, mounts, hand_metrics['height'])
            msg.append("<br>" + self.texts['head_destination_book'][h_dest])
            html_content += self._make_slide_card("🧠 두뇌선 (재능과 적성)", "#ffe696", "".join(msg))

        # 3. 감정선
        if 'heart' in features:
            f = features['heart']
            msg = []
            start_res = self.analyze_heart_start_book(f, hand_metrics['height'], mounts['수성'][1])
            start_txt = self.texts['heart_start_book'][start_res]
            msg.append(random.choice(start_txt) if isinstance(start_txt, list) else start_txt)

            shape_res = self.analyze_heart_shape_book(f)
            shape_txt = self.texts['heart_shape_book'][shape_res]
            msg.append("<br>" + (random.choice(shape_txt) if isinstance(shape_txt, list) else shape_txt))

            end_res = self.analyze_heart_end_book(f, mounts)
            msg.append("<br>" + self.texts['heart_end_book'][end_res])
            html_content += self._make_slide_card("❤️ 감정선 (사랑과 관계)", "#ff7878", "".join(msg))

        # 4. 운명선
        if 'fate' in features:
            f = features['fate']
            fate_msgs = []

            # [M자 손금 로직 수정: 평균 높이 교차 방식]
            is_m_shape = False
            # 신뢰도 조건 삭제: 선이 있으면 무조건 판단
            if 'head' in features and 'heart' in features:
                fate_pts = f['points']
                # y좌표: 0이 맨 위, 커질수록 아래
                fate_top_y = np.min(fate_pts[:, 1])      # 운명선의 천장 (최소 y)
                fate_bottom_y = np.max(fate_pts[:, 1])   # 운명선의 바닥 (최대 y)

                # 감정선의 평균 높이
                heart_mean_y = np.mean(features['heart']['points'][:, 1])
                # 두뇌선의 평균 높이
                head_mean_y = np.mean(features['head']['points'][:, 1])

                # 오차(tolerance)
                tolerance = hand_metrics['height'] * 0.05

                # 조건 1: 운명선이 두뇌선 영역을 '가로지르는가'?
                # 운명선 시작(Bottom)이 두뇌선 평균보다 아래에 있고 (y가 더 큼)
                # 운명선 끝(Top)이 두뇌선 평균보다 위에 있어야 함 (y가 더 작음)
                crosses_head = (fate_bottom_y > head_mean_y) and (fate_top_y < head_mean_y)

                # 조건 2: 운명선이 감정선 근처까지 올라갔는가?
                touches_heart = fate_top_y <= (heart_mean_y + tolerance)

                if crosses_head and touches_heart:
                    is_m_shape = True

            if is_m_shape:
                fate_msgs.append(self.texts['special_signs']['m_sign'])

            # 운명선 기본 해석 (신뢰도가 너무 낮으면 생략하는 기존 로직 유지하되 M자는 위에서 처리함)
            if f['conf'] < 0.4 and not is_m_shape:
                # 옅은 운명선 랜덤 2개
                fate_msgs.extend(random.sample(self.texts['fate_path']['support'], 2))
            else:
                f_start = self.analyze_fate_start_book(f, mounts, features)
                start_txt_list = self.texts['fate_start_book'][f_start]
                fate_msgs.append(random.choice(start_txt_list))

                f_end = self.analyze_fate_end_book(f, mounts, features)
                end_txt_list = self.texts['fate_end_book'][f_end]
                fate_msgs.append(random.choice(end_txt_list))

            if f['conf'] > 0.35 and not is_m_shape:
                fate_msgs.append(self.texts['special_signs']['rich_triangle'])

            fate_msgs.append("<br>" + random.choice(self.texts['fate_advice']))
            combined_msg = "<br><br>".join(fate_msgs)
            html_content += self._make_slide_card("🌟 운명선 (성공과 재물)", "#8c96ff", combined_msg)
        else:
            html_content += self._make_slide_card("🌟 운명선", "#8c96ff", self.texts['special_signs']['no_fate'])

        # --- 5. 19금 파트 (세 영역에서 1개씩 뽑아 하나의 카드에 출력) ---
        spicy_pool = []  # 뽑은 문장들을 담을 바구니

        # 1. 리비도 영역에서 1개 추출
        if 'life' in features:
            cv = self.analyze_life_curve(features['life'], mounts)
            k = 'level_5' if cv == 'big' else ('level_3' if cv == 'moderate' else 'level_1')
            # 리스트면 랜덤 선택, 아니면 그냥 가져옴
            lib_res = self.texts['libido'][k]
            spicy_pool.append(random.choice(lib_res) if isinstance(lib_res, list) else lib_res)

        # 2. 유혹 영역에서 1개 추출
        if 'heart' in features and 'head' in features:
            h_curv = features['heart']['curv']
            h_len_val = self.analyze_head_len(features['head'], mounts)
            if features['heart']['len_ratio'] < 0.4: k = 'bad_charmer'
            elif h_curv > 1.12: k = 'hot_lover'
            elif h_curv > 1.05 and h_len_val == 'long': k = 'shy_fox'
            else: k = 'cool_friend'
            sed_res = self.texts['seduction'][k]
            spicy_pool.append(random.choice(sed_res) if isinstance(sed_res, list) else sed_res)

        # 3. 판타지 영역에서 1개 추출
        if 'head' in features:
            k = 'deep' if abs(features['head']['slope']) > 0.45 else 'real'
            fan_res = self.texts['fantasy'][k]
            spicy_pool.append(random.choice(fan_res) if isinstance(fan_res, list) else fan_res)

        # 내용이 있으면 랜덤하게 섞어서 출력 (순서 고정하고 싶으면 shuffle 빼도 됨)
        random.shuffle(spicy_pool)

        # 아웃트로 1개 랜덤 추가
        final_outro = random.choice(self.texts['outro'])

        # [카드 출력] 하나의 카드에 모든 영역의 결과물을 몰아넣음
        full_text = "<br><br>".join(spicy_pool) + f"<br><br><div style='border-top:2px solid #ff0000; padding-top:10px; color:#900; font-weight:bold;'>{final_outro}</div>"

        html_content += self._make_slide_card(self.texts['spicy_title'], "#e74c3c", full_text)

        html_content += "</div></div>"
        return html_content

    def _make_slide_card(self, title, color, text):
        return f"""
        <div class="palm-card" style="border-top-color: {color};">
            <div class="palm-title">{title}</div>
            <div class="palm-desc">{text}</div>
        </div>
        """

# =========================================================
# 시각화 클래스
# =========================================================
class PalmAnalysisVisualizer:
    def __init__(self, model_path):
        self.model = YOLO(model_path)
        self.interpreter = PalmInterpreter()
        self.mp_hands = mp.solutions.hands
        self.hands = self.mp_hands.Hands(static_image_mode=True, max_num_hands=1)
        self.font_path = '/usr/share/fonts/truetype/nanum/NanumGothicBold.ttf'

        self.line_config = {
            0: {'ko': '운명선', 'name': 'fate', 'color': (140, 150, 255)},
            1: {'ko': '두뇌선', 'name': 'head', 'color': (255, 230, 150)},
            2: {'ko': '감정선', 'name': 'heart', 'color': (255, 120, 120)},
            3: {'ko': '생명선', 'name': 'life', 'color': (120, 255, 230)},
        }

    def apply_clahe(self, img):
        lab = cv2.cvtColor(img, cv2.COLOR_BGR2LAB)
        l, a, b = cv2.split(lab)
        clahe = cv2.createCLAHE(clipLimit=2.0, tileGridSize=(8, 8))
        return cv2.cvtColor(cv2.merge((clahe.apply(l), a, b)), cv2.COLOR_LAB2BGR)

    def draw_styled_label(self, img_bgr, text, position, color_bgr):
        img_pil = Image.fromarray(cv2.cvtColor(img_bgr, cv2.COLOR_BGR2RGB))
        draw = ImageDraw.Draw(img_pil)
        try: font = ImageFont.truetype(self.font_path, 65)
        except: font = ImageFont.load_default()

        bbox = draw.textbbox(position, text, font=font)
        padding = 20
        rect_coords = [bbox[0]-padding, bbox[1]-padding, bbox[2]+padding, bbox[3]+padding]

        color_rgb = color_bgr[::-1]
        draw.rounded_rectangle(rect_coords, radius=30, fill=color_rgb)

        brightness = (color_rgb[0] * 299 + color_rgb[1] * 587 + color_rgb[2] * 114) / 1000
        text_color = (0, 0, 0) if brightness > 128 else (255, 255, 255)

        draw.text(position, text, font=font, fill=text_color)
        return cv2.cvtColor(np.array(img_pil), cv2.COLOR_RGB2BGR)

    def visualize(self, image_path):
        origin_img = cv2.imread(image_path)
        if origin_img is None: return
        h, w = origin_img.shape[:2]
        canvas_img = origin_img.copy()

        img_rgb_mp = cv2.cvtColor(origin_img, cv2.COLOR_BGR2RGB)
        mp_results = self.hands.process(img_rgb_mp)

        mounts = {}; hand_metrics = {}; p17 = np.array([0,0]); p0 = np.array([0,0])

        if mp_results.multi_hand_landmarks:
            lm = mp_results.multi_hand_landmarks[0].landmark
            def p(idx): return np.array([int(lm[idx].x * w), int(lm[idx].y * h)])

            hand_metrics['height'] = np.linalg.norm(p(12) - p(0))
            hand_metrics['palm_width'] = np.linalg.norm(p(5) - p(17))

            p17, p0 = p(17), p(0)
            edge_center = (p17 + p0) * 0.5
            palm_center = p(9)
            vec = edge_center - palm_center
            mars_pos = (edge_center + (vec * 0.2)).astype(int)

            mounts['月'] = p0
            mounts['월구'] = p0 * 0.7 + p17 * 0.3
            mounts['火'] = mars_pos
            mounts['地'] = p0
            mounts['목성'] = p(5); mounts['토성'] = p(9)
            mounts['태양'] = p(13); mounts['수성'] = p(17)
            mounts['제2화성'] = mars_pos

            gu_locations = [('金', p(1)), ('木', p(5)), ('土', p(13)), ('水', p(17)), ('火', mars_pos), ('月', p(0))]
            for text, coord in gu_locations:
                overlay = canvas_img.copy()
                coord = (int(coord[0]), int(coord[1]))
                cv2.circle(overlay, coord, 70, (255, 255, 255), -1)
                cv2.addWeighted(overlay, 0.4, canvas_img, 0.6, 0, canvas_img)

                img_pil = Image.fromarray(cv2.cvtColor(canvas_img, cv2.COLOR_BGR2RGB))
                draw = ImageDraw.Draw(img_pil)
                gu_font = ImageFont.truetype(self.font_path, 80)
                tw = draw.textlength(text, font=gu_font)
                draw.text((coord[0]-tw/2, coord[1]-40), text, font=gu_font, fill=(100, 100, 100))
                canvas_img = cv2.cvtColor(np.array(img_pil), cv2.COLOR_RGB2BGR)

        ai_input = self.apply_clahe(origin_img)
        results = self.model.predict(ai_input, conf=0.05, verbose=False)
        best_lines = {}

        if results and results[0].keypoints is not None:
            kpts_all = results[0].keypoints.xy.cpu().numpy()
            clses = results[0].boxes.cls.cpu().numpy()
            confs = results[0].boxes.conf.cpu().numpy()
            for idx, kpts in enumerate(kpts_all):
                cls_id = int(clses[idx])
                if cls_id not in self.line_config: continue
                if cls_id not in best_lines or confs[idx] > best_lines[cls_id][0]:
                    best_lines[cls_id] = (confs[idx], kpts)

        for cls_id, (conf, kpts) in best_lines.items():
            cfg = self.line_config[cls_id]
            points = np.array([ [int(x), int(y)] for x, y in kpts if x > 0 ])
            if len(points) < 2: continue

            pts = points.reshape((-1, 1, 2))
            cv2.polylines(canvas_img, [pts], False, cfg['color'], 14, cv2.LINE_AA)

            name = cfg['name']
            label_pt = points[0]
            if name in ['heart', 'head']:
                dist0 = np.linalg.norm(points[0] - p17)
                dist1 = np.linalg.norm(points[-1] - p17)
                label_pt = points[0] if dist0 < dist1 else points[-1]
            elif name in ['life', 'fate']:
                dist0 = np.linalg.norm(points[0] - p0)
                dist1 = np.linalg.norm(points[-1] - p0)
                label_pt = points[0] if dist0 < dist1 else points[-1]

            canvas_img = self.draw_styled_label(canvas_img, cfg['ko'], tuple(label_pt), cfg['color'])

        plt.figure(figsize=(10, 10))
        plt.imshow(cv2.cvtColor(canvas_img, cv2.COLOR_BGR2RGB))
        plt.axis('off'); plt.show()

        features = self._extract_features(best_lines, hand_metrics)
        display(HTML(self.interpreter.interpret(features, mounts, hand_metrics)))

    def _extract_features(self, best_lines, metrics):
        features = {}
        for cls_id, (conf, kpts) in best_lines.items():
            pts = np.array([pt for pt in kpts if pt[0] > 0])
            if len(pts) < 2: continue
            name = self.line_config[cls_id]['name']
            curve_len = np.sum(np.sqrt(np.sum(np.diff(pts, axis=0)**2, axis=1)))
            euclidean = np.linalg.norm(pts[-1] - pts[0])
            vec = pts[-1] - pts[0]
            slope = vec[1] / (vec[0] + 1e-6)
            features[name] = {'points': pts, 'len_ratio': curve_len / metrics['height'], 'curv': curve_len / (euclidean + 1e-6), 'conf': conf, 'slope': slope}
        if 'head' in features and 'life' in features:
            features['head_life_gap'] = np.linalg.norm(features['head']['points'][0] - features['life']['points'][0]) / metrics['palm_width']
        return features

# ---------------------------------------------------------
# 실행
# ---------------------------------------------------------
BASE_PATH = '/content/drive/MyDrive'
MODEL_FILE = 'num_02.pt'
model_path = os.path.join(BASE_PATH, MODEL_FILE)
if os.path.exists(model_path):
    uploaded = files.upload()
    if uploaded:
        vis = PalmAnalysisVisualizer(model_path)
        vis.visualize(list(uploaded.keys())[0])